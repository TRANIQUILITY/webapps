<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>51labs | 월간 복식부기 재무관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal-content { transition: transform 0.3s ease-out; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: #3b82f6; color: white; }
        .nav-link:hover:not(.disabled) { background-color: #eff6ff; color: #1d4ed8; }
        .nav-link.disabled { color: #9ca3af; background-color: #f3f4f6; pointer-events: none; }
        .tab-link { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; }
        .tab-link.active { border-bottom-color: #3b82f6; color: #3b82f6; }
        .header-btn { display: none; }
        @keyframes blink-animation {
            50% { background-color: #dbeafe; } /* Tailwind CSS blue-100 */
        }
        .blink {
            animation: blink-animation 1.8s linear infinite;
            font-weight: 700;
            color: #1e40af; /* Tailwind CSS blue-800 */
        }
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border-left-color: #fff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .evidence-tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="relative min-h-screen md:flex">
        <!-- Mobile Menu Button -->
        <div class="md:hidden flex justify-between items-center bg-white p-4 shadow-md">
            <span class="text-2xl font-bold text-blue-600">51labs 재무</span>
            <button id="mobile-menu-button" class="text-gray-500 focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white w-64 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-20 shadow-lg md:shadow-md flex flex-col">
            <div class="p-4 text-2xl font-bold text-blue-600 border-b flex justify-between items-center">
                <span>51labs 재무</span>
                <button id="mobile-menu-close-button" class="md:hidden text-gray-500 focus:outline-none">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-y-auto">
                <div id="expense-menu-container">
                    <button id="expense-menu-toggle" class="w-full flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-money-check-dollar w-6 mr-3"></i>
                        <span class="flex-1 text-left">경비 처리</span>
                        <i id="expense-menu-chevron" class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div id="expense-months-nav" class="hidden pt-2 pl-4">
                        <div class="grid grid-cols-4 gap-2">
                        <!-- Monthly expense links will be generated by JS -->
                        </div>
                    </div>
                </div>
                <div class="pt-2 border-t mt-2">
                    <a href="#journal" class="nav-link flex items-center p-3 rounded-lg"><i class="fas fa-book w-6 mr-3"></i> 분개장</a>
                    <a href="#ledger" class="nav-link flex items-center p-3 rounded-lg"><i class="fas fa-book-open w-6 mr-3"></i> 총계정원장</a>
                    <a href="#reports" class="nav-link flex items-center p-3 rounded-lg"><i class="fas fa-chart-pie w-6 mr-3"></i> 재무제표</a>
                    <a href="#qna" class="nav-link flex items-center p-3 rounded-lg"><i class="fas fa-comments-dollar w-6 mr-3"></i> 세무 Q&A</a>
                    <a href="#dashboard" class="nav-link flex items-center p-3 rounded-lg"><i class="fas fa-tachometer-alt w-6 mr-3"></i> 대시보드</a>
                </div>
            </nav>
            <div class="p-4 border-t">
                <div id="user-info" class="text-xs text-gray-500"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <h1 id="page-title" class="text-xl md:text-2xl font-bold text-gray-800">대시보드</h1>
                <div class="flex items-center space-x-2">
                    <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                    <button id="import-csv-btn" class="header-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-upload mr-2"></i> CSV 가져오기</button>
                    <button id="export-csv-btn" class="header-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-file-csv mr-2"></i> CSV 내보내기</button>
                    <button id="add-transaction-btn" class="header-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-plus mr-2"></i> 거래 추가</button>
                    <button id="add-question-btn" class="header-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-question-circle mr-2"></i> 새 질문 작성</button>
                </div>
            </header>
            
            <div id="content-area" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-6">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="page-content"><div class="mb-6 border-b border-gray-200"><nav class="flex space-x-4" id="dashboard-tabs"><a href="#" data-tab="monthly" class="tab-link active py-2 px-4 text-sm font-medium">월별</a><a href="#" data-tab="quarterly" class="tab-link py-2 px-4 text-sm font-medium">분기별</a></nav></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold mb-4">기간별 손익 추이</h3><div class="h-64"><canvas id="income-trend-chart"></canvas></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold mb-4">자산 현황</h3><div class="h-64"><canvas id="asset-status-chart"></canvas></div></div></div></div>

                <!-- Expense Processing View -->
                <div id="expenses-view" class="page-content hidden"><div class="bg-white p-6 rounded-lg shadow max-w-2xl mx-auto"><h2 class="text-xl font-bold mb-6">간편 경비처리</h2><form id="expense-form" class="space-y-4"><div><label for="exp-date" class="block text-sm font-medium text-gray-700">처리일</label><input type="date" id="exp-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label for="exp-type" class="block text-sm font-medium text-gray-700">경비 종류</label><select id="exp-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div><div><label for="exp-payment-method" class="block text-sm font-medium text-gray-700">경비 처리 방법</label><select id="exp-payment-method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required><option value="법인 카드">법인 카드</option><option value="체크 카드">체크 카드</option><option value="현금">현금</option></select></div><div><label for="exp-amount" class="block text-sm font-medium text-gray-700">금액</label><input type="number" id="exp-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0" required min="0"></div><div><label for="exp-description" class="block text-sm font-medium text-gray-700">적요</label><input type="text" id="exp-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="예: 7월분 급여"></div><div><label class="block text-sm font-medium text-gray-700">증빙자료</label><div class="mt-1"><div class="flex border-b border-gray-200 text-sm" id="evidence-tabs"><button type="button" data-type="link" class="evidence-tab active p-2"><i class="fas fa-link mr-1"></i> 파일 링크</button><button type="button" data-type="gdrive" class="evidence-tab p-2 text-gray-500"><i class="fab fa-google-drive mr-1"></i> Google Drive</button></div><div id="evidence-inputs-container" class="mt-2"><div id="link-container" class="evidence-input"><input type="url" id="exp-receipt-url-link" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/receipt.pdf"></div><div id="gdrive-container" class="evidence-input hidden"><input type="url" id="exp-receipt-url-gdrive" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://drive.google.com/file/d/..."></div></div><input type="hidden" id="exp-receipt-url"></div></div><div class="pt-4 text-right"><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">분개 생성</button></div></form></div></div>

                <!-- Journal View -->
                <div id="journal-view" class="page-content hidden"><div class="bg-white p-6 rounded-lg shadow"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3">거래일</th><th scope="col" class="px-6 py-3">차변 계정</th><th scope="col" class="px-6 py-3">대변 계정</th><th scope="col" class="px-6 py-3">적요</th><th scope="col" class="px-6 py-3 text-right">금액</th><th scope="col" class="px-6 py-3 text-center">증빙</th><th scope="col" class="px-6 py-3 text-center">Q&A</th></tr></thead><tbody id="journal-table-body"></tbody></table></div></div></div>

                <!-- Ledger View -->
                <div id="ledger-view" class="page-content hidden"><div class="mb-6"><label for="ledger-account-select" class="block mb-2 text-sm font-medium text-gray-900">계정과목 선택</label><select id="ledger-account-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-1/3 p-2.5"></select></div><div class="bg-white p-6 rounded-lg shadow"><h2 id="ledger-title" class="text-xl font-bold mb-4"></h2><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3">거래일</th><th scope="col" class="px-6 py-3">적요</th><th scope="col" class="px-6 py-3 text-right">차변</th><th scope="col" class="px-6 py-3 text-right">대변</th><th scope="col" class="px-6 py-3 text-right">잔액</th></tr></thead><tbody id="ledger-table-body"></tbody></table></div></div></div>

                <!-- Reports View -->
                <div id="reports-view" class="page-content hidden"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-4">손익계산서</h2><table class="w-full text-sm"><tbody id="income-statement-body"></tbody></table></div><div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-4">재무상태표</h2><table class="w-full text-sm"><tbody id="balance-sheet-body"></tbody></table></div></div></div>
                
                <!-- Q&A View -->
                <div id="qna-view" class="page-content hidden"><div class="bg-white p-6 rounded-lg shadow"><div id="qna-list-container"></div></div></div>
            </div>
        </main>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform scale-95"><form id="transaction-form" class="p-6"><h2 class="text-2xl font-bold mb-6">거래 입력</h2><div class="space-y-4"><div><label for="tx-date" class="block text-sm font-medium text-gray-700">거래일</label><input type="date" id="tx-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div class="relative">
                        <label for="tx-description" class="block text-sm font-medium text-gray-700">적요</label>
                        <input type="text" id="tx-description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm pr-24" placeholder="예: 스타벅스 커피" required>
                        <button type="button" id="ai-suggest-btn" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-sm font-semibold text-white bg-gradient-to-r from-sky-500 to-indigo-500 rounded-r-md hover:from-sky-600 hover:to-indigo-600"><span class="mr-1">✨</span> AI 추천</button>
                    </div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="tx-debit-account" class="block text-sm font-medium text-gray-700">차변 (Dr.)</label><select id="tx-debit-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div><div><label for="tx-credit-account" class="block text-sm font-medium text-gray-700">대변 (Cr.)</label><select id="tx-credit-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div></div><div><label for="tx-amount" class="block text-sm font-medium text-gray-700">금액</label><input type="number" id="tx-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0" required min="0"></div><div><label for="tx-receipt-url" class="block text-sm font-medium text-gray-700">증빙자료 링크</label><input type="url" id="tx-receipt-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/receipt.jpg"></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">취소</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">저장</button></div></form></div></div>

    <!-- Q&A Modal -->
    <div id="qna-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform scale-95"><form id="qna-form" class="p-6"><h2 class="text-2xl font-bold mb-6">세무 Q&A</h2><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">관련 거래</label><p id="qna-tx-info" class="mt-1 text-sm text-gray-600 bg-gray-100 p-2 rounded-md"></p></div><input type="hidden" id="qna-tx-id"><input type="hidden" id="qna-tx-desc"><div><label for="qna-title" class="block text-sm font-medium text-gray-700">질문 제목</label><input type="text" id="qna-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div><div><label for="qna-question" class="block text-sm font-medium text-gray-700">질문 내용</label><textarea id="qna-question" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></textarea></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" id="qna-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">취소</button><button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">질문 저장</button></div></form></div></div>

    <!-- AI Analysis Result Modal -->
    <div id="ai-result-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content transform scale-95"><div class="p-6"><h2 class="text-2xl font-bold mb-4 text-violet-600 flex items-center"><span class="mr-2">✨</span> AI 재무 분석 리포트</h2><div id="ai-result-content" class="prose max-w-none text-gray-700 max-h-96 overflow-y-auto"></div><div class="mt-6 text-right"><button type="button" id="ai-result-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">닫기</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "dummy", authDomain: "dummy.firebaseapp.com", projectId: "dummy" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bookkeeping-app';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null, transactions = [], qnaThreads = [], incomeTrendChart, assetStatusChart;

        const chartOfAccounts = {
            '자산': [{ code: '101', name: '현금및현금성자산' },{ code: '120', name: '투자자산' },{ code: '177', name: '선급비용' },],
            '부채': [{ code: '253', name: '미지급금' },{ code: '254', name: '예수금' },{ code: '255', name: '가수금' },{ code: '261', name: '미지급법인세' },],
            '자본': [{ code: '311', name: '자본금' },{ code: '371', name: '이익잉여금' },],
            '수익': [{ code: '401', name: '배당금수익' },{ code: '402', name: '유가증권처분이익' },{ code: '403', name: '이자수익' },],
            '비용': [
                { code: '510', name: '급여' }, { code: '511', name: '퇴직급여' }, { code: '512', name: '복리후생비' },
                { code: '513', name: '여비교통비' }, { code: '514', name: '접대비' }, { code: '515', name: '통신비' },
                { code: '516', name: '광고선전비' }, { code: '517', name: '세금과공과' }, { code: '518', name: '임차료' }, 
                { code: '519', name: '수수료비용' }, { code: '520', name: '보험료' }, { code: '521', name: '차량유지비' }, 
                { code: '522', name: '교육훈련비' }, { code: '523', name: '도서인쇄비' }, { code: '524', name: '수선비' }, 
                { code: '525', name: '이자비용' }, { code: '526', name: '소모품비' }, { code: '530', name: '기부금' }, 
                { code: '540', name: '잡비' }
            ]
        };

        const expenseTypes = [
            { value: 'salary', text: '급여 지급', account: '급여' }, { value: 'rent', text: '임차료', account: '임차료' },
            { value: 'commission', text: '지급 수수료', account: '수수료비용' }, { value: 'taxes', text: '세금과 공과금', account: '세금과공과' },
            { value: 'transport', text: '교통비', account: '여비교통비' }, { value: 'dom_travel', text: '국내 출장비', account: '여비교통비' },
            { value: 'overseas_travel', text: '해외 출장비', account: '여비교통비' }, { value: 'meals_entertainment', text: '식사 및 접대비', account: '접대비' },
            { value: 'donation', text: '기부금', account: '기부금' }, { value: 'insurance', text: '보험료', account: '보험료' },
            { value: 'training', text: '교육 훈련비', account: '교육훈련비' }, { value: 'vehicle', text: '차량유지비', account: '차량유지비' },
            { value: 'books', text: '도서 구입비', account: '도서인쇄비' }, { value: 'interest', text: '이자비용', account: '이자비용' },
            { value: 'repairs', text: '수선비', account: '수선비' }, { value: 'communication', text: '통신비', account: '통신비' },
            { value: 'advertising', text: '광고선전비', account: '광고선전비' }, { value: 'supplies', text: '소모품비', account: '소모품비' },
            { value: 'misc', text: '기타', account: '잡비' }
        ];

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-info').textContent = `UserID: ${userId}`;
                initializeDashboard();
                initializeExpenseNav();
                listenToTransactions();
                listenToQnA();
                
                const currentMonth = new Date().getMonth();
                const initialLink = document.querySelector(`#expense-months-nav .nav-link[data-month="${currentMonth + 1}"]`);
                if (initialLink) {
                    updateActiveView('expenses', initialLink);
                    document.getElementById('expense-months-nav').classList.remove('hidden');
                    document.getElementById('expense-menu-chevron').classList.add('rotate-180');
                }
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });

        const modal = document.getElementById('transaction-modal'), addTxBtn = document.getElementById('add-transaction-btn'), cancelBtn = document.getElementById('cancel-btn'), pageTitle = document.getElementById('page-title'), exportCsvBtn = document.getElementById('export-csv-btn'), importCsvBtn = document.getElementById('import-csv-btn'), csvFileInput = document.getElementById('csv-file-input'), addQuestionBtn = document.getElementById('add-question-btn'), aiAnalysisBtn = document.getElementById('ai-analysis-btn');
        const qnaModal = document.getElementById('qna-modal'), qnaCancelBtn = document.getElementById('qna-cancel-btn');
        const aiResultModal = document.getElementById('ai-result-modal'), aiResultCloseBtn = document.getElementById('ai-result-close-btn');

        addTxBtn.addEventListener('click', () => modal.classList.remove('hidden'));
        cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
        addQuestionBtn.addEventListener('click', () => openQnaModal());
        qnaCancelBtn.addEventListener('click', () => qnaModal.classList.add('hidden'));
        qnaModal.addEventListener('click', (e) => { if (e.target === qnaModal) qnaModal.classList.add('hidden'); });
        if(aiAnalysisBtn) aiAnalysisBtn.addEventListener('click', runFinancialAnalysis);
        if(aiResultCloseBtn) aiResultCloseBtn.addEventListener('click', () => aiResultModal.classList.add('hidden'));
        
        exportCsvBtn.addEventListener('click', () => {
            const activeLink = document.querySelector('.nav-link.active');
            if (!activeLink) return;
            const activePage = activeLink.getAttribute('href').substring(1);
            if (activePage === 'journal') exportJournalToCSV();
            if (activePage === 'ledger') exportLedgerToCSV();
            if (activePage === 'reports') exportReportsToCSV();
        });
        importCsvBtn.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', importFromCSV);

        function setupNavLinks() {
            const navLinks = document.querySelectorAll('a.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if(link.classList.contains('disabled')) return;
                    const targetId = link.getAttribute('href').substring(1);
                    updateActiveView(targetId, link);
                });
            });
        }

        function updateActiveView(targetId, activeLink) {
            if (!activeLink) return;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            activeLink.classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(page => page.classList.toggle('hidden', page.id !== `${targetId}-view`));
            pageTitle.textContent = activeLink.dataset.title || activeLink.textContent.trim();
            
            const isDashboard = targetId === 'dashboard';
            const isExpenses = targetId.startsWith('expenses');
            const isJournal = targetId === 'journal';
            const isLedger = targetId === 'ledger';
            const isReports = targetId === 'reports';
            const isQnA = targetId === 'qna';

            importCsvBtn.style.display = isJournal ? 'flex' : 'none';
            exportCsvBtn.style.display = (isJournal || isLedger || isReports) ? 'flex' : 'none';
            addTxBtn.style.display = isJournal ? 'flex' : 'none';
            addQuestionBtn.style.display = isQnA ? 'flex' : 'none';
            if(aiAnalysisBtn) aiAnalysisBtn.style.display = isReports ? 'flex' : 'none';
            
            if (isDashboard) generateDashboardData();
            if (isReports) generateReports();
            if (isQnA) renderQnAList();
        }

        const txForm = document.getElementById('transaction-form');
        txForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newTx = {
                date: document.getElementById('tx-date').value, description: document.getElementById('tx-description').value,
                debit: document.getElementById('tx-debit-account').value, credit: document.getElementById('tx-credit-account').value,
                amount: parseFloat(document.getElementById('tx-amount').value), receiptUrl: document.getElementById('tx-receipt-url').value,
            };
            saveTransaction(newTx);
            txForm.reset();
            modal.classList.add('hidden');
        });

        const expenseForm = document.getElementById('expense-form');
        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const typeValue = document.getElementById('exp-type').value;
            const expenseType = expenseTypes.find(et => et.value === typeValue);
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const date = document.getElementById('exp-date').value;
            const description = document.getElementById('exp-description').value;
            const paymentMethod = document.getElementById('exp-payment-method').value;
            
            const activeTab = document.querySelector('#evidence-tabs .evidence-tab.active').dataset.type;
            let receiptUrl = '';
             if (activeTab === 'link') {
                receiptUrl = document.getElementById('exp-receipt-url-link').value;
            } else if (activeTab === 'gdrive') {
                receiptUrl = document.getElementById('exp-receipt-url-gdrive').value;
            }
            
            if(expenseType) {
                const newTx = { date, description: `[자동][${paymentMethod}] ${description}`, debit: expenseType.account, credit: '현금및현금성자산', amount, receiptUrl };
                saveTransaction(newTx);
                expenseForm.reset();
                document.getElementById('exp-date').valueAsDate = new Date();
                alert('경비 처리가 완료되어 분개장에 자동으로 기록되었습니다.');
            }
        });
        
        async function saveTransaction(txData) {
            if (!userId || !txData.debit || !txData.credit) return;
            if (txData.debit === txData.credit) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), { ...txData, createdAt: new Date() });
            } catch (error) { console.error("Error adding document: ", error); }
        }

        function listenToTransactions() {
            if (!userId) return;
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/transactions`), orderBy("date", "desc"));
            onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderJournal();
                const activeLink = document.querySelector('.nav-link.active');
                if (activeLink) {
                    const currentView = activeLink.getAttribute('href').substring(1);
                    if (currentView === 'reports') generateReports();
                    if (currentView === 'dashboard') generateDashboardData();
                }
            });
        }
        
        function renderJournal() {
            const tableBody = document.getElementById('journal-table-body');
            tableBody.innerHTML = '';
            transactions.forEach(tx => {
                const receiptLink = tx.receiptUrl ? `<a href="${tx.receiptUrl}" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-link"></i></a>` : '';
                const qnaButton = `<button data-tx-id="${tx.id}" data-tx-desc="${tx.date} / ${tx.description}" class="text-purple-500 hover:text-purple-700 ask-qna-btn"><i class="fas fa-comments"></i></button>`;
                tableBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${tx.date}</td><td class="px-6 py-4">${tx.debit}</td><td class="px-6 py-4">${tx.credit}</td><td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${tx.description}</td><td class="px-6 py-4 text-right">${tx.amount.toLocaleString()}</td><td class="px-6 py-4 text-center">${receiptLink}</td><td class="px-6 py-4 text-center">${qnaButton}</td></tr>`;
            });
            document.querySelectorAll('.ask-qna-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const target = e.currentTarget;
                openQnaModal(target.dataset.txId, target.dataset.txDesc);
            }));
        }
        
        function renderLedger(accountName) {
            const ledgerBody = document.getElementById('ledger-table-body');
            document.getElementById('ledger-title').textContent = `${accountName} 원장`;
            ledgerBody.innerHTML = '';
            let balance = 0;
            const accountType = getAccountType(accountName);
            const isDebitPositive = ['자산', '비용'].includes(accountType);
            const filteredTxs = transactions.filter(tx => tx.debit === accountName || tx.credit === accountName).sort((a,b) => new Date(a.date) - new Date(b.date));
            filteredTxs.forEach(tx => {
                const debitAmount = tx.debit === accountName ? tx.amount : 0;
                const creditAmount = tx.credit === accountName ? tx.amount : 0;
                balance += isDebitPositive ? (debitAmount - creditAmount) : (creditAmount - debitAmount);
                ledgerBody.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${tx.date}</td><td class="px-6 py-4">${tx.description}</td><td class="px-6 py-4 text-right">${debitAmount > 0 ? debitAmount.toLocaleString() : '-'}</td><td class="px-6 py-4 text-right">${creditAmount > 0 ? creditAmount.toLocaleString() : '-'}</td><td class="px-6 py-4 text-right font-bold">${balance.toLocaleString()}</td></tr>`;
            });
        }
        
        function getBalances() {
            const balances = {};
            [].concat(...Object.values(chartOfAccounts)).forEach(acc => balances[acc.name] = 0);
            transactions.forEach(tx => {
                const debitType = getAccountType(tx.debit);
                const creditType = getAccountType(tx.credit);
                if (balances[tx.debit] !== undefined) balances[tx.debit] += ['자산', '비용'].includes(debitType) ? tx.amount : -tx.amount;
                if (balances[tx.credit] !== undefined) balances[tx.credit] += ['부채', '자본', '수익'].includes(creditType) ? tx.amount : -tx.amount;
            });
            return balances;
        }

        function generateReports() {
            const balances = getBalances();
            const totalRevenue = chartOfAccounts['수익'].reduce((sum, acc) => sum + (balances[acc.name] || 0), 0);
            const totalExpenses = chartOfAccounts['비용'].reduce((sum, acc) => sum + (balances[acc.name] || 0), 0);
            const netIncome = totalRevenue - totalExpenses;
            renderIncomeStatement(balances, totalRevenue, totalExpenses, netIncome);
            renderBalanceSheet(balances, netIncome);
        }

        function renderIncomeStatement(balances, totalRevenue, totalExpenses, netIncome) {
            const isBody = document.getElementById('income-statement-body');
            isBody.innerHTML = `<tr class="bg-gray-50 font-bold"><td class="p-2" colspan="2">수익</td></tr>`;
            chartOfAccounts['수익'].forEach(acc => { if(balances[acc.name]) isBody.innerHTML += `<tr><td class="p-2 pl-6">${acc.name}</td><td class="p-2 text-right">${balances[acc.name].toLocaleString()}</td></tr>`; });
            isBody.innerHTML += `<tr class="font-semibold"><td class="p-2">수익 합계</td><td class="p-2 text-right">${totalRevenue.toLocaleString()}</td></tr>`;
            isBody.innerHTML += `<tr class="bg-gray-50 font-bold"><td class="p-2" colspan="2">비용</td></tr>`;
            chartOfAccounts['비용'].forEach(acc => { if(balances[acc.name]) isBody.innerHTML += `<tr><td class="p-2 pl-6">${acc.name}</td><td class="p-2 text-right">${balances[acc.name].toLocaleString()}</td></tr>`; });
            isBody.innerHTML += `<tr class="font-semibold"><td class="p-2">비용 합계</td><td class="p-2 text-right">${totalExpenses.toLocaleString()}</td></tr>`;
            isBody.innerHTML += `<tr class="bg-blue-100 font-bold text-blue-800"><td class="p-2">당기순이익</td><td class="p-2 text-right">${netIncome.toLocaleString()}</td></tr>`;
        }

        function renderBalanceSheet(balances, netIncome) {
            const bsBody = document.getElementById('balance-sheet-body');
            bsBody.innerHTML = '';
            const finalBalances = JSON.parse(JSON.stringify(balances));
            finalBalances['이익잉여금'] = (finalBalances['이익잉여금'] || 0) + netIncome;
            let totalAssets = 0, totalLiabilities = 0, totalEquity = 0;
            bsBody.innerHTML += `<tr class="bg-gray-50 font-bold"><td class="p-2" colspan="2">자산</td></tr>`;
            chartOfAccounts['자산'].forEach(acc => { const balance = finalBalances[acc.name] || 0; totalAssets += balance; if (balance) bsBody.innerHTML += `<tr><td class="p-2 pl-6">${acc.name}</td><td class="p-2 text-right">${balance.toLocaleString()}</td></tr>`; });
            bsBody.innerHTML += `<tr class="font-semibold"><td class="p-2">자산 총계</td><td class="p-2 text-right">${totalAssets.toLocaleString()}</td></tr>`;
            bsBody.innerHTML += `<tr class="bg-gray-50 font-bold"><td class="p-2" colspan="2">부채</td></tr>`;
            chartOfAccounts['부채'].forEach(acc => { const balance = finalBalances[acc.name] || 0; totalLiabilities += balance; if (balance) bsBody.innerHTML += `<tr><td class="p-2 pl-6">${acc.name}</td><td class="p-2 text-right">${balance.toLocaleString()}</td></tr>`; });
            bsBody.innerHTML += `<tr class="font-semibold"><td class="p-2">부채 총계</td><td class="p-2 text-right">${totalLiabilities.toLocaleString()}</td></tr>`;
            bsBody.innerHTML += `<tr class="bg-gray-50 font-bold"><td class="p-2" colspan="2">자본</td></tr>`;
            chartOfAccounts['자본'].forEach(acc => { const balance = finalBalances[acc.name] || 0; totalEquity += balance; if (balance) bsBody.innerHTML += `<tr><td class="p-2 pl-6">${acc.name}</td><td class="p-2 text-right">${balance.toLocaleString()}</td></tr>`; });
            bsBody.innerHTML += `<tr class="font-semibold"><td class="p-2">자본 총계</td><td class="p-2 text-right">${totalEquity.toLocaleString()}</td></tr>`;
            bsBody.innerHTML += `<tr class="bg-blue-100 font-bold text-blue-800"><td class="p-2">부채와자본 총계</td><td class="p-2 text-right">${(totalLiabilities + totalEquity).toLocaleString()}</td></tr>`;
        }
        
        function populateAccountSelects() {
            const selects = [document.getElementById('tx-debit-account'), document.getElementById('tx-credit-account'), document.getElementById('ledger-account-select')];
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">선택...</option>';
                for (const [type, accounts] of Object.entries(chartOfAccounts)) {
                    const optgroup = document.createElement('optgroup'); optgroup.label = type;
                    accounts.forEach(account => { const option = document.createElement('option'); option.value = account.name; option.textContent = `${account.code} - ${account.name}`; optgroup.appendChild(option); });
                    select.appendChild(optgroup);
                }
            });
        }
        
        function getAccountType(accountName) {
            for (const type in chartOfAccounts) { if (chartOfAccounts[type].some(acc => acc.name === accountName)) return type; } return null;
        }

        function downloadCSV(csvContent, filename) {
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri); link.setAttribute("download", filename);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function exportJournalToCSV() {
            const headers = ['Date', 'Debit', 'Credit', 'Description', 'Amount', 'ReceiptURL'];
            const rows = transactions.map(tx => [tx.date, tx.debit, tx.credit, `"${tx.description.replace(/"/g, '""')}"`, tx.amount, tx.receiptUrl].join(','));
            downloadCSV([headers.join(','), ...rows].join('\n'), `51labs_journal_${new Date().toISOString().slice(0,10)}.csv`);
        }

        function exportLedgerToCSV() {
            const accountName = document.getElementById('ledger-account-select').value;
            if (!accountName) return;
            const headers = ['Date', 'Description', 'Debit', 'Credit', 'Balance'];
            const rows = Array.from(document.querySelectorAll('#ledger-table-body tr')).map(row => Array.from(row.querySelectorAll('td')).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(','));
            downloadCSV([headers.join(','), ...rows].join('\n'), `51labs_ledger_${accountName}_${new Date().toISOString().slice(0,10)}.csv`);
        }

        function exportReportsToCSV() {
            let csvContent = "손익계산서\n" + ['항목', '금액'].join(',') + '\n';
            document.querySelectorAll('#income-statement-body tr').forEach(row => { csvContent += Array.from(row.querySelectorAll('td')).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(',') + '\n'; });
            csvContent += "\n재무상태표\n" + ['항목', '금액'].join(',') + '\n';
            document.querySelectorAll('#balance-sheet-body tr').forEach(row => { csvContent += Array.from(row.querySelectorAll('td')).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(',') + '\n'; });
            downloadCSV(csvContent, `51labs_reports_${new Date().toISOString().slice(0,10)}.csv`);
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const rows = e.target.result.split('\n').slice(1);
                rows.forEach(row => {
                    if (!row) return;
                    const columns = row.split(',').map(s => s.trim().replace(/"/g, ''));
                    const [date, debit, credit, description, amount, receiptUrl] = columns;
                    if (date && debit && credit && description && amount) {
                        saveTransaction({ date, debit, credit, description, amount: parseFloat(amount), receiptUrl: receiptUrl || ''});
                    }
                });
                csvFileInput.value = '';
            };
            reader.readAsText(file);
        }

        function initializeDashboard() {
            const incomeCtx = document.getElementById('income-trend-chart').getContext('2d');
            incomeTrendChart = new Chart(incomeCtx, { type: 'bar', data: { labels: [], datasets: [{ label: '수익', data: [], backgroundColor: 'rgba(59, 130, 246, 0.7)' }, { label: '비용', data: [], backgroundColor: 'rgba(239, 68, 68, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true } } } });
            const assetCtx = document.getElementById('asset-status-chart').getContext('2d');
            assetStatusChart = new Chart(assetCtx, { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#ec4899'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            document.getElementById('dashboard-tabs').addEventListener('click', e => { e.preventDefault(); if (e.target.tagName === 'A') { document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active')); e.target.classList.add('active'); generateDashboardData(); } });
        }

        function initializeExpenseNav() {
            const navContainer = document.getElementById('expense-months-nav').querySelector('.grid');
            const expTypeSelect = document.getElementById('exp-type');
            navContainer.innerHTML = '';
            
            expTypeSelect.innerHTML = '<option value="">선택...</option>';
            expenseTypes.forEach(et => {
                const option = document.createElement('option');
                option.value = et.value;
                option.textContent = et.text;
                expTypeSelect.appendChild(option);
            });

            const currentMonth = new Date().getMonth(); // 0-11
            for (let i = 0; i < 12; i++) {
                const month = i + 1;
                const link = document.createElement('a');
                link.href = '#expenses';
                link.dataset.month = month;
                link.dataset.title = `${month}월 경비처리`;
                link.className = 'nav-link text-center p-2 rounded-md text-sm';
                link.innerHTML = `${month}월`;
                if (i === currentMonth) {
                    link.classList.add('blink');
                }
                navContainer.appendChild(link);
            }
            setupNavLinks();
        }

        function generateDashboardData() {
            if (!transactions.length) return;
            const activeTab = document.querySelector('.tab-link.active').dataset.tab;
            const periodData = {};
            transactions.forEach(tx => {
                const date = new Date(tx.date);
                const year = date.getFullYear();
                let periodKey;
                if (activeTab === 'monthly') { const month = date.getMonth(); periodKey = `${year}-${String(month + 1).padStart(2, '0')}`; } 
                else { const quarter = Math.floor(date.getMonth() / 3) + 1; periodKey = `${year}-Q${quarter}`; }
                if (!periodData[periodKey]) periodData[periodKey] = { revenue: 0, expense: 0 };
                if (getAccountType(tx.debit) === '비용') periodData[periodKey].expense += tx.amount;
                if (getAccountType(tx.credit) === '수익') periodData[periodKey].revenue += tx.amount;
            });
            const sortedPeriods = Object.keys(periodData).sort();
            incomeTrendChart.data.labels = sortedPeriods;
            incomeTrendChart.data.datasets[0].data = sortedPeriods.map(p => periodData[p].revenue);
            incomeTrendChart.data.datasets[1].data = sortedPeriods.map(p => periodData[p].expense);
            incomeTrendChart.update();
            const balances = getBalances();
            const assetBalances = chartOfAccounts['자산'].map(acc => ({ name: acc.name, balance: balances[acc.name] || 0 })).filter(a => a.balance > 0);
            assetStatusChart.data.labels = assetBalances.map(a => a.name);
            assetStatusChart.data.datasets[0].data = assetBalances.map(a => a.balance);
            assetStatusChart.update();
        }
        
        // --- Q&A Functions ---
        const qnaForm = document.getElementById('qna-form');
        function openQnaModal(txId = null, txDesc = null) {
            qnaForm.reset();
            const txInfoEl = document.getElementById('qna-tx-info');
            const txIdEl = document.getElementById('qna-tx-id');
            const txDescEl = document.getElementById('qna-tx-desc');

            if (txId && txDesc) {
                txInfoEl.textContent = txDesc;
                txInfoEl.parentElement.style.display = 'block';
                txIdEl.value = txId;
                txDescEl.value = txDesc;
            } else {
                txInfoEl.parentElement.style.display = 'none';
                txIdEl.value = '';
                txDescEl.value = '';
            }
            qnaModal.classList.remove('hidden');
        }

        qnaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return;
            const newQna = {
                title: document.getElementById('qna-title').value,
                question: document.getElementById('qna-question').value,
                transactionId: document.getElementById('qna-tx-id').value || null,
                transactionDescription: document.getElementById('qna-tx-desc').value || null,
                status: '답변 대기중',
                createdAt: new Date(),
                replies: []
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/qna`), newQna);
                qnaModal.classList.add('hidden');
            } catch (error) { console.error("Error adding Q&A:", error); }
        });

        function listenToQnA() {
            if (!userId) return;
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/qna`), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                qnaThreads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('qna-view').offsetParent !== null) {
                    renderQnAList();
                }
            });
        }
        
        function renderQnAList() {
            const container = document.getElementById('qna-list-container');
            container.innerHTML = '';
            if (qnaThreads.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">아직 등록된 질문이 없습니다.</p>`;
                return;
            }
            qnaThreads.forEach(thread => {
                const statusColor = thread.status === '답변 완료' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const repliesHtml = thread.replies.map(reply => `
                    <div class="mt-2 ml-4 p-2 bg-gray-50 rounded-md">
                        <p class="text-sm text-gray-800">${reply.text}</p>
                        <p class="text-xs text-gray-500 text-right mt-1">${new Date(reply.repliedAt.seconds * 1000).toLocaleString()}</p>
                    </div>
                `).join('');

                const threadHtml = `
                    <div class="border-b pb-4 mb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">${thread.title}</p>
                                ${thread.transactionDescription ? `<p class="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-1 rounded">관련 거래: ${thread.transactionDescription}</p>` : ''}
                            </div>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded ${statusColor}">${thread.status}</span>
                        </div>
                        <p class="mt-2 text-gray-700">${thread.question}</p>
                        <p class="text-xs text-gray-400 text-right mt-1">${new Date(thread.createdAt.seconds * 1000).toLocaleString()}</p>
                        ${repliesHtml}
                        <form class="reply-form mt-3" data-id="${thread.id}">
                            <div class="relative">
                                <textarea class="w-full p-2 border rounded-md text-sm" placeholder="세무사 답변 입력..."></textarea>
                                <button type="button" class="ai-reply-btn absolute top-2 right-2 bg-purple-500 text-white px-2 py-1 text-xs rounded-md hover:bg-purple-600">✨ AI 답변 초안</button>
                            </div>
                            <div class="flex justify-end mt-2">
                                <button type="submit" class="bg-blue-500 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-600">답변 등록</button>
                            </div>
                        </form>
                    </div>
                `;
                container.innerHTML += threadHtml;
            });

            document.querySelectorAll('.reply-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const threadId = e.currentTarget.dataset.id;
                    const replyText = e.currentTarget.querySelector('textarea').value;
                    if (!replyText) return;
                    const threadRef = doc(db, `artifacts/${appId}/users/${userId}/qna`, threadId);
                    await updateDoc(threadRef, { status: '답변 완료', replies: arrayUnion({ text: replyText, repliedAt: new Date() }) });
                });
            });

            document.querySelectorAll('.ai-reply-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const form = e.currentTarget.closest('form');
                    const threadId = form.dataset.id;
                    const thread = qnaThreads.find(t => t.id === threadId);
                    if (!thread) return;

                    const originalText = e.currentTarget.innerHTML;
                    e.currentTarget.innerHTML = `<div class="spinner"></div>`;
                    e.currentTarget.disabled = true;

                    const prompt = `다음은 1인 법인 대표의 세무 관련 질문입니다. 당신은 친절하고 전문적인 세무사입니다. 이 질문에 대해 명확하고 이해하기 쉬운 답변의 초안을 작성해주세요.\n\n[관련 거래 정보]\n${thread.transactionDescription || '없음'}\n\n[질문 내용]\n${thread.question}`;
                    const resultText = await callGemini(prompt);
                    form.querySelector('textarea').value = resultText;
                    
                    e.currentTarget.innerHTML = originalText;
                    e.currentTarget.disabled = false;
                });
            });
        }

        // --- Gemini API Functions ---
        async function callGemini(prompt, schema = null) {
            const apiKey = ""; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            let payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    console.error("API call failed with status:", response.status);
                    return null;
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                }
                return null;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return null;
            }
        }

        document.getElementById('ai-suggest-btn').addEventListener('click', async (e) => {
            const description = document.getElementById('tx-description').value;
            if (!description) {
                alert('적요를 먼저 입력해주세요.');
                return;
            }

            const originalBtn = e.currentTarget;
            originalBtn.innerHTML = `<div class="spinner"></div>`;
            originalBtn.disabled = true;

            const accountsList = JSON.stringify(chartOfAccounts, null, 2);
            const prompt = `다음은 회계 거래 내역 설명입니다: "${description}". 이 거래에 가장 적합한 차변(debit)과 대변(credit) 계정과목을 아래 계정과목표에서 찾아 JSON 형식으로 추천해주세요. 대금 지급은 주로 '현금및현금성자산'에서 이루어집니다.\n\n계정과목표:\n${accountsList}`;
            const schema = {
                type: "OBJECT",
                properties: {
                    debitAccount: { "type": "STRING" },
                    creditAccount: { "type": "STRING" }
                },
                required: ["debitAccount", "creditAccount"]
            };

            const resultJson = await callGemini(prompt, schema);
            if (resultJson) {
                try {
                    const result = JSON.parse(resultJson);
                    document.getElementById('tx-debit-account').value = result.debitAccount;
                    document.getElementById('tx-credit-account').value = result.creditAccount;
                } catch (e) {
                    console.error("Failed to parse AI response:", e);
                }
            }
            
            originalBtn.innerHTML = `<span class="mr-1">✨</span> AI 추천`;
            originalBtn.disabled = false;
        });

        async function runFinancialAnalysis() {
            const balances = getBalances();
            const totalRevenue = chartOfAccounts['수익'].reduce((sum, acc) => sum + (balances[acc.name] || 0), 0);
            const totalExpenses = chartOfAccounts['비용'].reduce((sum, acc) => sum + (balances[acc.name] || 0), 0);
            const netIncome = totalRevenue - totalExpenses;
            
            const finalBalances = { ...balances };
            finalBalances['이익잉여금'] = (finalBalances['이익잉여금'] || 0) + netIncome;
            const totalAssets = chartOfAccounts['자산'].reduce((sum, acc) => sum + (finalBalances[acc.name] || 0), 0);
            const totalLiabilities = chartOfAccounts['부채'].reduce((sum, acc) => sum + (finalBalances[acc.name] || 0), 0);
            const totalEquity = chartOfAccounts['자본'].reduce((sum, acc) => sum + (finalBalances[acc.name] || 0), 0);

            const reportData = {
                "총수익": totalRevenue, "총비용": totalExpenses, "당기순이익": netIncome,
                "총자산": totalAssets, "총부채": totalLiabilities, "총자본": totalEquity
            };

            const prompt = `다음은 한 1인 법인의 재무 데이터입니다. 이 데이터를 바탕으로 대표가 이해하기 쉽게 회사의 재무 상태를 분석해주세요. 긍정적인 부분과 주의해야 할 부분을 나누어 설명해주세요.\n\n데이터:\n${JSON.stringify(reportData, null, 2)}`;
            
            const contentEl = document.getElementById('ai-result-content');
            contentEl.innerHTML = '<div class="flex justify-center items-center h-40"><div class="spinner" style="width:40px; height:40px; border-left-color:#4f46e5;"></div></div>';
            aiResultModal.classList.remove('hidden');

            const resultText = await callGemini(prompt);
            contentEl.innerHTML = resultText ? resultText.replace(/\n/g, '<br>') : "분석 결과를 가져오는데 실패했습니다.";
        }
        
        // --- Evidence Tabs ---
        const evidenceTabs = document.getElementById('evidence-tabs');
        const evidenceInputs = document.getElementById('evidence-inputs-container');
        evidenceTabs.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if(button) {
                evidenceTabs.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('text-gray-500');
                });
                button.classList.add('active');
                button.classList.remove('text-gray-500');
                
                evidenceInputs.querySelectorAll('.evidence-input').forEach(input => input.classList.add('hidden'));
                document.getElementById(`${button.dataset.type}-container`).classList.remove('hidden');
            }
        });
        
        document.getElementById('tx-date').valueAsDate = new Date();
        document.getElementById('exp-date').valueAsDate = new Date();
        populateAccountSelects();
        document.getElementById('ledger-account-select').addEventListener('change', (e) => { if (e.target.value) renderLedger(e.target.value); });
        
        // --- Mobile Menu ---
        const sidebar = document.getElementById('sidebar');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenuCloseButton = document.getElementById('mobile-menu-close-button');
        mobileMenuButton.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
        mobileMenuCloseButton.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));
        
        // --- Expense Menu Toggle ---
        const expenseMenuToggle = document.getElementById('expense-menu-toggle');
        const expenseMonthsNav = document.getElementById('expense-months-nav');
        const expenseMenuChevron = document.getElementById('expense-menu-chevron');
        expenseMenuToggle.addEventListener('click', () => {
            expenseMonthsNav.classList.toggle('hidden');
            expenseMenuChevron.classList.toggle('rotate-180');
        });
        
        // Set initial view after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
             const currentMonth = new Date().getMonth();
             const initialLink = document.querySelector(`#expense-months-nav a.nav-link[data-month="${currentMonth + 1}"]`);
             if (initialLink) {
                updateActiveView('expenses', initialLink);
                expenseMonthsNav.classList.remove('hidden');
                expenseMenuChevron.classList.add('rotate-180');
             }
        });

    </script>
</body>
</html>
