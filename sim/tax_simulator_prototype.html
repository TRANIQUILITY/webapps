<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>법인세 시뮬레이터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .gradient-text { background: linear-gradient(to right, #1e3a8a, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .table-container { max-height: 60vh; overflow-y: auto; }
        th { position: sticky; top: 0; background-color: #e5e7eb; z-index: 10; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { margin-bottom: 0.5rem; color: #4b5563; font-weight: 500;}
        .input-group input, .input-group select { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; text-align: right; }
        .input-group select { text-align: left; }
        .korean-display {
            color: #1e3a8a;
            font-weight: 500;
            padding-top: 0.5rem;
            font-size: 0.875rem;
            height: 2rem;
            text-align: right;
        }
        .formula-item { border-left: 4px solid #3b82f6; padding-left: 1rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold gradient-text">법인세 시뮬레이터</h1>
            <p class="mt-2 text-gray-600">선납 세액을 고려한 장기 재무 흐름 분석</p>
        </header>

        <main>
            <!-- Settings -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">시뮬레이션 설정</h2>
                <div class="flex flex-col gap-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        <div class="input-group">
                            <label for="simulationYears">기간 (년)</label>
                            <select id="simulationYears" class="bg-white p-2 border border-gray-300 rounded-lg">
                                <option value="10">10년</option>
                                <option value="15">15년</option>
                                <option value="20">20년</option>
                                <option value="30" selected>30년</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="revenueGrowth">연수익률 증가율 (%)</label>
                            <input type="number" id="revenueGrowth" value="10">
                        </div>
                        <div class="input-group">
                            <label for="revenueYear2">2년차 매출 (백만원)</label>
                            <input type="number" id="revenueYear2" value="250">
                            <div id="revenueYear2Korean" class="korean-display"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="input-group">
                            <label for="tradingCost">연간 거래 경비 (백만원)</label>
                            <input type="number" id="tradingCost" value="5">
                            <div id="tradingCostKorean" class="korean-display"></div>
                        </div>
                        <div class="input-group">
                            <label for="expensesEarly">초기 월경비 (백만원)</label>
                            <input type="number" id="expensesEarly" value="6">
                            <div id="expensesEarlyKorean" class="korean-display"></div>
                        </div>
                        <div class="input-group">
                            <label for="expensesMid">중기 월경비 (백만원)</label>
                            <input type="number" id="expensesMid" value="10">
                            <div id="expensesMidKorean" class="korean-display"></div>
                        </div>
                        <div class="input-group">
                            <label for="expensesLate">후기 월경비 (백만원)</label>
                            <input type="number" id="expensesLate" value="15">
                             <div id="expensesLateKorean" class="korean-display"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-center items-center gap-4">
                    <button id="runSimButton" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">시뮬레이션 실행</button>
                    <button id="exportButton" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">내보내기</button>
                    <button id="importButton" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">가져오기</button>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md text-center">
                    <h3 id="summary-revenue-title" class="text-lg font-semibold text-gray-500">30년차 예상 매출</h3>
                    <p id="summary-revenue" class="text-3xl font-bold text-blue-900 mt-2">-</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md text-center">
                    <h3 id="summary-total-tax-title" class="text-lg font-semibold text-gray-500">30년 총 실납부 법인세</h3>
                    <p id="summary-total-tax" class="text-3xl font-bold text-red-600 mt-2">-</p>
                </div>
                <div class="bg-blue-800 text-white p-6 rounded-xl shadow-lg text-center">
                    <h3 id="summary-tax-asset-title" class="text-lg font-semibold text-blue-200">30년 후 누적 세금 자산</h3>
                    <p id="summary-tax-asset" class="text-4xl font-bold mt-2">-</p>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-md mb-8">
                 <div class="chart-container" style="position: relative; height:40vh; width:100%">
                    <canvas id="simulationChart"></canvas>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="bg-white rounded-xl shadow-md mb-8">
                <div class="p-4 border-b">
                    <h2 class="text-xl font-bold text-gray-800">연도별 상세 시뮬레이션 결과</h2>
                </div>
                <div class="table-container">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                            <tr>
                                <th scope="col" class="px-4 py-3">연차</th>
                                <th scope="col" class="px-4 py-3">매출 (수익)</th>
                                <th scope="col" class="px-4 py-3">과세표준</th>
                                <th scope="col" class="px-4 py-3 text-red-600">실납부 법인세</th>
                                <th scope="col" class="px-4 py-3 text-blue-600">누적 세금자산</th>
                            </tr>
                        </thead>
                        <tbody id="simulation-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

             <!-- Calculation Formulas -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">산출 공식 안내</h2>
                <div class="space-y-4">
                    <div class="formula-item">
                        <h3 class="font-bold text-gray-700">과세표준 (세금 부과 대상 소득)</h3>
                        <p class="text-gray-600 text-sm">매출(수익) - (연간 운영 경비 + 연간 거래 경비)</p>
                    </div>
                    <div class="formula-item">
                        <h3 class="font-bold text-gray-700">산출세액 (내야 할 총 법인세)</h3>
                        <p class="text-gray-600 text-sm">과세표준에 따라 법인세율(9.9% ~ 22%)을 적용하여 계산된 금액</p>
                    </div>
                    <div class="formula-item">
                        <h3 class="font-bold text-gray-700">실납부 법인세 (실제 추가 납부액)</h3>
                        <p class="text-gray-600 text-sm">산출세액 - (당해년도 선납세금 + 이월된 누적 세금자산)  [단, 0보다 작을 수 없음]</p>
                    </div>
                    <div class="formula-item">
                        <h3 class="font-bold text-gray-700">누적 세금자산 (이월되는 세금)</h3>
                        <p class="text-gray-600 text-sm">(직전년도 누적 세금자산 + 당해년도 선납세금) - 당해년도에 공제받은 금액</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
let simulationChart = null;

document.addEventListener('DOMContentLoaded', () => {

    const formatKRW = (num) => {
        if (num === 0) return '0원';
        if (!num) return '-';
        const numAbs = Math.abs(num);
        if (numAbs >= 100000000) {
            return `${(num / 100000000).toFixed(1)}억`;
        }
        return new Intl.NumberFormat('ko-KR').format(Math.round(num / 10000)) + '만';
    };

    const formatKRWDetail = (num) => new Intl.NumberFormat('ko-KR').format(Math.round(num)) + '원';
    
    const numberToKorean = (numStr) => {
        const num = parseInt(numStr, 10);
        if (isNaN(num) || num === 0) return '[ 영 원 ]';

        const fullNum = num * 1000000;
        const units = ['', '만', '억', '조', '경'];
        const digits = ['일', '이', '삼', '사', '오', '육', '칠', '팔', '구'];
        const smallUnits = ['', '십', '백', '천'];
        
        let result = [];
        let tempNum = fullNum;
        
        while (tempNum > 0) {
            const part = tempNum % 10000;
            tempNum = Math.floor(tempNum / 10000);
            if (part > 0) {
                let partStr = '';
                for (let i = 0; i < 4; i++) {
                    const digit = Math.floor((part / Math.pow(10, i)) % 10);
                    if (digit > 0) {
                        partStr = (digit === 1 && i > 0 ? '' : digits[digit - 1]) + smallUnits[i] + partStr;
                    }
                }
                result.push(partStr.replace(/^일(십|백|천)/, '$1') + units.shift());
            } else {
                units.shift();
            }
        }
        return `[ ${result.reverse().join(' ').trim()}원 ]`;
    };

    const runSimulation = () => {
        const years = parseInt(document.getElementById('simulationYears').value);
        const growthRate = parseFloat(document.getElementById('revenueGrowth').value) / 100;
        const revenueYear2 = parseFloat(document.getElementById('revenueYear2').value) * 1000000 || 0;
        const tradingCost = parseFloat(document.getElementById('tradingCost').value) * 1000000 || 0;
        const expEarly = parseFloat(document.getElementById('expensesEarly').value) * 1000000 || 0;
        const expMid = parseFloat(document.getElementById('expensesMid').value) * 1000000 || 0;
        const expLate = parseFloat(document.getElementById('expensesLate').value) * 1000000 || 0;
        
        const results = [];
        let taxAssetCarryforward = 0;
        let currentRevenue = revenueYear2;

        for (let year = 1; year <= years; year++) {
            let yearRevenue, annualExpenses, tradingCostsForYear;

            if (year === 1) {
                yearRevenue = revenueYear2 * (5 / 12);
                annualExpenses = expEarly * 5;
                tradingCostsForYear = tradingCost * (5 / 12);
            } else {
                if (year > 2) {
                    currentRevenue *= (1 + growthRate);
                }
                yearRevenue = currentRevenue;
                
                if (year <= 3) annualExpenses = expEarly * 12;
                else if (year <= 8) annualExpenses = expMid * 12;
                else annualExpenses = expLate * 12;

                tradingCostsForYear = tradingCost;
            }
            
            const taxableIncome = yearRevenue - annualExpenses - tradingCostsForYear;
            
            let corporateTaxDue = 0;
            if (taxableIncome > 0) {
                if (year === 1) {
                    corporateTaxDue = taxableIncome * 0.099;
                } else {
                    if (taxableIncome <= 200000000) {
                        corporateTaxDue = taxableIncome * 0.11;
                    } else {
                        corporateTaxDue = (200000000 * 0.11) + ((taxableIncome - 200000000) * 0.22);
                    }
                }
            }

            const prepaidTax = yearRevenue * 0.135;
            const totalCreditAvailable = prepaidTax + taxAssetCarryforward;
            const creditUsed = Math.min(corporateTaxDue, totalCreditAvailable);
            const actualTaxPaid = corporateTaxDue - creditUsed;
            taxAssetCarryforward = totalCreditAvailable - creditUsed;

            results.push({
                year,
                revenue: yearRevenue,
                taxableIncome,
                actualTaxPaid,
                taxAssetCarryforward,
            });
        }
        return results;
    };

    const renderTable = (data) => {
        const tableBody = document.getElementById('simulation-table-body');
        tableBody.innerHTML = ''; 
        data.forEach(d => {
            const row = `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-900">${d.year}년차</td>
                    <td class="px-4 py-3">${formatKRW(d.revenue)}</td>
                    <td class="px-4 py-3 ${d.taxableIncome < 0 ? 'text-red-500' : ''}">${formatKRW(d.taxableIncome)}</td>
                    <td class="px-4 py-3 font-bold text-red-600">${formatKRW(d.actualTaxPaid)}</td>
                    <td class="px-4 py-3 font-bold text-blue-600">${formatKRW(d.taxAssetCarryforward)}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };
    
    const updateSummary = (data) => {
        const years = data.length;
        const lastYearData = data[data.length - 1];
        const totalTaxPaid = data.reduce((sum, d) => sum + d.actualTaxPaid, 0);

        document.getElementById('summary-revenue-title').textContent = `${years}년차 예상 매출`;
        document.getElementById('summary-total-tax-title').textContent = `${years}년 총 실납부 법인세`;
        document.getElementById('summary-tax-asset-title').textContent = `${years}년 후 누적 세금 자산`;

        document.getElementById('summary-revenue').textContent = formatKRW(lastYearData.revenue);
        document.getElementById('summary-total-tax').textContent = formatKRW(totalTaxPaid);
        document.getElementById('summary-tax-asset').textContent = formatKRW(lastYearData.taxAssetCarryforward);
    };

    const renderChart = (data) => {
        if (simulationChart) {
            simulationChart.destroy();
        }
        const ctx = document.getElementById('simulationChart').getContext('2d');
        simulationChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => `${d.year}년`),
                datasets: [
                    {
                        label: '매출',
                        data: data.map(d => d.revenue),
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        type: 'line',
                        yAxisID: 'y-axis-revenue',
                        tension: 0.1,
                        order: 1
                    },
                     {
                        label: '누적 세금 자산',
                        data: data.map(d => d.taxAssetCarryforward),
                        backgroundColor: 'rgba(34, 197, 94, 0.6)',
                        borderColor: '#22c55e',
                        yAxisID: 'y-axis-revenue',
                        order: 2
                    },
                    {
                        label: '실납부 법인세',
                        data: data.map(d => d.actualTaxPaid),
                        backgroundColor: 'rgba(220, 38, 38, 0.6)',
                        borderColor: '#dc2626',
                        yAxisID: 'y-axis-tax',
                        order: 3
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false, },
                scales: {
                    x: { stacked: true },
                    'y-axis-revenue': {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: '매출 / 세금자산' },
                        ticks: { callback: value => formatKRW(value) }
                    },
                    'y-axis-tax': {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: '실납부 법인세' },
                        ticks: { callback: value => formatKRW(value) },
                        grid: { drawOnChartArea: false },
                        stacked: true
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${formatKRWDetail(context.raw)}`
                        }
                    }
                }
            }
        });
    };

    const getSettings = () => ({
        simulationYears: document.getElementById('simulationYears').value,
        revenueGrowth: document.getElementById('revenueGrowth').value,
        revenueYear2: document.getElementById('revenueYear2').value,
        tradingCost: document.getElementById('tradingCost').value,
        expensesEarly: document.getElementById('expensesEarly').value,
        expensesMid: document.getElementById('expensesMid').value,
        expensesLate: document.getElementById('expensesLate').value,
    });

    const setSettings = (settings) => {
        document.getElementById('simulationYears').value = settings.simulationYears || 30;
        document.getElementById('revenueGrowth').value = settings.revenueGrowth || 10;
        document.getElementById('revenueYear2').value = settings.revenueYear2 || 250;
        document.getElementById('tradingCost').value = settings.tradingCost || 5;
        document.getElementById('expensesEarly').value = settings.expensesEarly || 6;
        document.getElementById('expensesMid').value = settings.expensesMid || 10;
        document.getElementById('expensesLate').value = settings.expensesLate || 15;
        
        inputsToConvert.forEach(({inputId, outputId}) => updateKoreanDisplay(inputId, outputId));
    };

    const handleExport = () => {
        const settings = getSettings();
        const jsonString = JSON.stringify(settings, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const now = new Date();
        const dateString = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
        a.href = url;
        a.download = `tax_simulator_${dateString}.json`;
        document.body.appendChild(a);
a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    const handleImport = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedSettings = JSON.parse(e.target.result);
                setSettings(importedSettings);
                main();
            } catch (error) {
                alert('잘못된 JSON 파일입니다. 파일 내용을 확인해주세요.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    };

    const main = () => {
        const simulationResults = runSimulation();
        updateSummary(simulationResults);
        renderTable(simulationResults);
        renderChart(simulationResults);
    };

    const inputsToConvert = [
        {inputId: 'revenueYear2', outputId: 'revenueYear2Korean'},
        {inputId: 'tradingCost', outputId: 'tradingCostKorean'},
        {inputId: 'expensesEarly', outputId: 'expensesEarlyKorean'},
        {inputId: 'expensesMid', outputId: 'expensesMidKorean'},
        {inputId: 'expensesLate', outputId: 'expensesLateKorean'}
    ];
    
    const updateKoreanDisplay = (inputId, outputId) => {
        const inputElement = document.getElementById(inputId);
        const outputElement = document.getElementById(outputId);
        const value = inputElement.value;
        outputElement.textContent = value ? numberToKorean(value) : '';
    };

    inputsToConvert.forEach(({inputId, outputId}) => {
        const inputElement = document.getElementById(inputId);
        inputElement.addEventListener('input', () => updateKoreanDisplay(inputId, outputId));
        updateKoreanDisplay(inputId, outputId);
    });

    document.getElementById('runSimButton').addEventListener('click', main);
    document.getElementById('exportButton').addEventListener('click', handleExport);
    document.getElementById('importButton').addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', handleImport);
    
    main(); // Initial run on page load
});
</script>

</body>
</html>

