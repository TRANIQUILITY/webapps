import React, { useState, useMemo, useCallback } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } from 'recharts';

// --- 유틸리티 함수 ---
const formatNumber = (num) => {
  if (typeof num !== 'number') return num;
  return new Intl.NumberFormat('ko-KR').format(num);
};

const parseNumber = (str) => {
  if (typeof str === 'number') return str;
  const parsed = Number(String(str).replace(/,/g, ''));
  return isNaN(parsed) ? 0 : parsed;
};

// --- 컴포넌트 정의 ---

// AI 기능 로딩 및 결과 표시를 위한 모달 컴포넌트
const AiModal = ({ isOpen, onClose, title, content, isLoading }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div className="p-6 overflow-y-auto">
                    {isLoading ? (
                        <div className="flex flex-col items-center justify-center h-48">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                            <p className="mt-4 text-gray-600">AI가 답변을 생성하고 있습니다...</p>
                        </div>
                    ) : (
                        <div className="text-gray-700 whitespace-pre-wrap leading-relaxed" dangerouslySetInnerHTML={{ __html: content }}></div>
                    )}
                </div>
                <div className="p-4 bg-gray-50 border-t rounded-b-xl text-right">
                    <button onClick={onClose} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        닫기
                    </button>
                </div>
            </div>
        </div>
    );
};


const InfoCard = ({ title, value, unit = '원', color = 'text-gray-900' }) => (
  <div className="bg-white p-4 rounded-lg shadow">
    <h3 className="text-sm font-medium text-gray-500">{title}</h3>
    <p className={`mt-1 text-2xl font-bold ${color}`}>
      {formatNumber(value)} <span className="text-base font-normal">{unit}</span>
    </p>
  </div>
);

const InputForm = ({ config, setConfig, runSimulation, resetSimulation, isSimulating, onLifestyleSuggest }) => {
    
    const handleAccountChange = (id, field, value) => {
       setConfig(prev => ({
           ...prev,
           accounts: prev.accounts.map(acc =>
               acc.id === id ? { ...acc, [field]: value } : acc
           )
       }));
    };
    
    const addAccount = () => {
        if (config.accounts.length < 5) {
            const newAccount = { id: Date.now(), name: `신규 연금 ${config.accounts.length + 1}`, type: '개인연금', taxStatus: '과세', balance: 0 };
            setConfig(prev => ({ ...prev, accounts: [...prev.accounts, newAccount] }));
        }
    };

    const removeAccount = (id) => {
        setConfig(prev => ({ ...prev, accounts: prev.accounts.filter(acc => acc.id !== id) }));
    };

    const handleConfigChange = (e) => {
        const { name, value } = e.target;
        setConfig(prev => ({ ...prev, [name]: parseNumber(value) }));
    };

    return (
        <div className="space-y-6">
            <div className="bg-gray-50 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-gray-800 mb-4">1. 사적연금 정보 입력 (최대 5개)</h2>
                <div className="space-y-4">
                    {config.accounts.map((account) => (
                        <div key={account.id} className="flex flex-col md:flex-row items-center gap-3 p-3 bg-white rounded-lg border">
                            <div className="w-full flex-grow grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                                <input type="text" value={account.name} onChange={(e) => handleAccountChange(account.id, 'name', e.target.value)} placeholder="계좌 별칭" className="p-2 border-gray-300 rounded-md"/>
                                 <select value={account.type} onChange={(e) => handleAccountChange(account.id, 'type', e.target.value)} className="p-2 border-gray-300 rounded-md bg-white">
                                    <option>개인연금</option>
                                    <option>퇴직연금/IRP</option>
                                    <option>연금보험</option>
                                    <option>기타</option>
                                </select>
                                 <select value={account.taxStatus} onChange={(e) => handleAccountChange(account.id, 'taxStatus', e.target.value)} className="p-2 border-gray-300 rounded-md bg-white">
                                    <option value="과세">과세</option>
                                    <option value="비과세">비과세</option>
                                </select>
                                <div className="relative rounded-md shadow-sm">
                                    <input type="text" value={formatNumber(account.balance)} onChange={(e) => handleAccountChange(account.id, 'balance', parseNumber(e.target.value))} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                                    <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">원</span></div>
                                </div>
                            </div>
                           {config.accounts.length > 1 && (
                               <button 
                                   onClick={() => removeAccount(account.id)} 
                                   className="w-full md:w-auto flex-shrink-0 px-4 py-2 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600 transition-colors"
                               >
                                   삭제
                               </button>
                           )}
                        </div>
                    ))}
                </div>
                {config.accounts.length < 5 && <button onClick={addAccount} className="mt-4 px-4 py-2 text-sm font-semibold text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200">+ 연금 추가하기</button>}
            </div>

            <div className="bg-gray-50 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-gray-800 mb-4">2. 은퇴 계획 상세 설정</h2>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label htmlFor="monthlyLivingExpenses" className="block text-sm font-medium text-gray-700">희망 월 생활비</label>
                        <div className="mt-1 flex items-center gap-2">
                            <div className="relative rounded-md shadow-sm flex-grow">
                                <input type="text" name="monthlyLivingExpenses" id="monthlyLivingExpenses" value={formatNumber(config.monthlyLivingExpenses)} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                                <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">원</span></div>
                            </div>
                            <button onClick={onLifestyleSuggest} title="AI 라이프스타일 제안받기" className="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors">✨</button>
                        </div>
                    </div>
                     <div>
                       <label htmlFor="inflationRate" className="block text-sm font-medium text-gray-700">예상 물가상승률</label>
                       <div className="mt-1 relative rounded-md shadow-sm">
                            <input type="text" name="inflationRate" id="inflationRate" value={config.inflationRate} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                           <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">%</span></div>
                       </div>
                    </div>
                    <div>
                       <label htmlFor="nationalPensionStartAge" className="block text-sm font-medium text-gray-700">국민연금 수령 시작 나이</label>
                       <div className="mt-1 relative rounded-md shadow-sm">
                            <input type="text" name="nationalPensionStartAge" id="nationalPensionStartAge" value={formatNumber(config.nationalPensionStartAge)} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                           <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">세</span></div>
                       </div>
                    </div>
                    <div>
                       <label htmlFor="nationalPensionMonthlyAmount" className="block text-sm font-medium text-gray-700">국민연금 월 예상 수령액 (현재가치)</label>
                       <div className="mt-1 relative rounded-md shadow-sm">
                            <input type="text" name="nationalPensionMonthlyAmount" id="nationalPensionMonthlyAmount" value={formatNumber(config.nationalPensionMonthlyAmount)} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                           <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">원</span></div>
                       </div>
                    </div>
                 </div>
            </div>
            
            <div className="mt-6 flex items-center justify-end gap-x-4">
                <button type="button" onClick={resetSimulation} className="px-4 py-2 text-sm font-semibold text-gray-700 bg-white rounded-md shadow-sm hover:bg-gray-100 border border-gray-300">초기화</button>
                <button type="button" onClick={runSimulation} disabled={isSimulating} className="px-6 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300">
                    {isSimulating ? '계산 중...' : '시뮬레이션 시작'}
                </button>
            </div>
        </div>
    );
};


const Summary = ({ summaryData, onAnalysisSuggest }) => {
  if (!summaryData) return null;
  return (
    <div className="mt-8">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-gray-800">📊 시뮬레이션 요약</h2>
        <button onClick={onAnalysisSuggest} className="flex items-center gap-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors text-sm font-semibold">
            ✨ AI 종합 분석 및 코칭
        </button>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <InfoCard title="총 사적연금 인출액" value={summaryData.totalPrivateWithdrawn} unit="원" />
        <InfoCard title="총 국민연금 수령액 (물가상승 반영)" value={summaryData.totalNationalPension} unit="원" />
        <InfoCard title="사적연금 납부 세금" value={summaryData.totalTax} unit="원" color="text-red-600" />
        <InfoCard title="31년 후 최종 잔액" value={summaryData.finalBalance} unit="원" color="text-indigo-600" />
      </div>
       <div className="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-800 rounded-r-lg">
        <p className="font-bold">종합 은퇴자금 설계 전략</p>
        <p className="text-sm">
          국민연금 수령 전에는 사적연금을 활용하고, 수령 후에는 물가상승률이 반영된 국민연금을 주된 현금흐름으로 사용하여 사적연금 인출을 최소화함으로써 자산 수명을 연장하고 절세 효과를 극대화합니다.
        </p>
      </div>
    </div>
  );
};

const IncomeCompositionChart = ({ data }) => {
    if (!data || data.length === 0) return null;
    return (
        <div className="mt-8">
            <h2 className="text-xl font-bold text-gray-800 mb-4">📈 연차별 총 생활비 구성</h2>
            <div className="bg-white p-4 rounded-xl shadow-lg w-full h-80">
                <ResponsiveContainer>
                    <BarChart data={data} stackOffset="sign" margin={{ top: 20, right: 20, left: 30, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="age" label={{ value: '나이', position: 'insideBottom', offset: -5 }} />
                        <YAxis tickFormatter={(value) => `${formatNumber(value/10000)}만`} label={{ value: '금액(원)', angle: -90, position: 'insideLeft', offset: -20 }}/>
                        <Tooltip formatter={(value) => `${formatNumber(value)} 원`} />
                        <Legend verticalAlign="top" height={36}/>
                        <Bar dataKey="privatePensionWithdrawn" stackId="a" fill="#8884d8" name="사적연금 인출액" />
                        <Bar dataKey="nationalPensionIncome" stackId="a" fill="#82ca9d" name="국민연금 수령액" />
                    </BarChart>
                </ResponsiveContainer>
            </div>
        </div>
    );
};

const AssetChart = ({ data }) => {
  if (!data || data.length === 0) return null;
  return (
    <div className="mt-8">
        <h2 className="text-xl font-bold text-gray-800 mb-4">📉 연차별 사적연금 자산 변화</h2>
        <div className="bg-white p-4 rounded-xl shadow-lg w-full h-80">
            <ResponsiveContainer>
                <AreaChart data={data} margin={{ top: 5, right: 20, left: 30, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="age" label={{ value: '나이', position: 'insideBottom', offset: -5 }} />
                    <YAxis tickFormatter={(value) => `${formatNumber(value/10000)}만`} label={{ value: '금액(원)', angle: -90, position: 'insideLeft', offset: -20 }} />
                    <Tooltip formatter={(value) => `${formatNumber(value)} 원`} />
                    <Legend verticalAlign="top" height={36}/>
                    <Area type="monotone" dataKey="nonTaxableBalance" stackId="1" stroke="#82ca9d" fill="#82ca9d" name="비과세 연금" />
                    <Area type="monotone" dataKey="taxableBalance" stackId="1" stroke="#8884d8" fill="#8884d8" name="과세 연금" />
                </AreaChart>
            </ResponsiveContainer>
        </div>
    </div>
  );
};

const ResultTable = ({ data }) => {
  if (!data || data.length === 0) return null;
  return (
    <div className="mt-8">
      <h2 className="text-xl font-bold text-gray-800 mb-4">📋 연차별 상세 내역</h2>
      <div className="overflow-x-auto bg-white rounded-xl shadow-lg">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">나이</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">총 생활비</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">국민연금</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사적연금 인출</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">납부 세금</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">연말 총 잔액</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {data.map((row) => (
              <tr key={row.year} className="hover:bg-gray-50">
                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{row.age}세</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-700">{formatNumber(row.totalIncome)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-green-700">{formatNumber(row.nationalPensionIncome)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-blue-700">{formatNumber(row.privatePensionWithdrawn)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-red-600">{formatNumber(row.taxPaid)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm font-semibold text-indigo-700">{formatNumber(row.totalBalance)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};


// 메인 앱 컴포넌트
export default function App() {
  const initialConfig = {
    accounts: [
        { id: 1, name: '개인연금 #01', type: '개인연금', taxStatus: '과세', balance: 121000000 },
        { id: 2, name: '개인연금 #02', type: '개인연금', taxStatus: '과세', balance: 80000000 },
        { id: 3, name: '개인연금 #03 (ISA전환)', type: '개인연금', taxStatus: '비과세', balance: 102000000 },
        { id: 4, name: 'IRP', type: '퇴직연금/IRP', taxStatus: '과세', balance: 51000000 },
    ],
    monthlyLivingExpenses: 2100000,
    startAge: 55,
    nationalPensionStartAge: 65,
    nationalPensionMonthlyAmount: 1800000,
    inflationRate: 2.8,
  };

  const [config, setConfig] = useState(initialConfig);
  const [simulationData, setSimulationData] = useState([]);
  const [isSimulating, setIsSimulating] = useState(false);
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalTitle, setModalTitle] = useState('');
  const [modalContent, setModalContent] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);

  const callGeminiAPI = async (prompt) => {
    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
    try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
            let text = result.candidates[0].content.parts[0].text;
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            return text;
        } else { return "AI로부터 답변을 받는 데 실패했습니다. 잠시 후 다시 시도해주세요."; }
    } catch (error) {
        console.error("Gemini API Error:", error);
        return "AI 기능 사용 중 오류가 발생했습니다. 네트워크 연결을 확인하거나 잠시 후 다시 시도해주세요.";
    }
  };

  const handleLifestyleSuggest = async () => {
    setModalTitle("✨ AI 라이프스타일 제안");
    setModalContent('');
    setIsAiLoading(true);
    setIsModalOpen(true);
    const prompt = `대한민국에서 은퇴를 앞둔 사람이 희망 월 생활비로 ${formatNumber(config.monthlyLivingExpenses)}원을 설정했습니다. 이 예산으로 누릴 수 있는 풍요롭고 현실적인 은퇴 후 라이프스타일을 구체적으로 제안해주세요. 취미, 여가, 사회 활동, 건강 관리, 자기 계발 등 다양한 측면을 포함하여 긍정적이고 희망적인 어조로 작성해주세요. 응답은 한국어로 해주세요. 중요한 키워드는 **굵게** 표시해주세요.`;
    const suggestion = await callGeminiAPI(prompt);
    setModalContent(suggestion);
    setIsAiLoading(false);
  };

  const handleAnalysisSuggest = async () => {
    if (simulationData.length === 0) return;
    setModalTitle("✨ AI 종합 분석 및 코칭");
    setModalContent('');
    setIsAiLoading(true);
    setIsModalOpen(true);
    const summary = summaryData;
    const prompt = `은퇴 설계 시뮬레이션 결과입니다. 이 결과를 바탕으로 사용자에게 전문 은퇴 컨설턴트의 입장에서 종합적인 분석과 따뜻한 코칭을 제공해주세요.\n\n**시뮬레이션 결과:**\n- 총 사적연금 인출액: ${formatNumber(summary.totalPrivateWithdrawn)}원\n- 총 국민연금 수령액: ${formatNumber(summary.totalNationalPension)}원\n- 31년 후 최종 잔액: ${formatNumber(summary.finalBalance)}원\n- 희망 월 생활비 (초기): ${formatNumber(config.monthlyLivingExpenses)}원\n\n**분석 및 코칭 가이드라인:**\n1.  **결과 요약:** 시뮬레이션 결과를 긍정적으로 요약해주세요.\n2.  **강점 분석:** 이 계획의 강점을 짚어주세요. (예: 국민연금과 사적연금의 조화, 비과세 자산 활용 등)\n3.  **고려사항 및 제안:** 최종 잔액을 기준으로, 자금이 부족하다면 부드럽고 실행 가능한 대안(예: 소비 조정, 추가 수입원 탐색)을 제시하고, 자금이 충분하다면 삶의 질을 높일 수 있는 방안(예: 버킷리스트 실현, 상속/증여 계획)을 제안해주세요.\n4.  **격려 메시지:** 성공적인 은퇴 준비를 격려하는 희망적인 메시지로 마무리해주세요.\n\n전체적으로 긍정적이고 지지하는 톤을 유지하며, 응답은 한국어로 해주세요. 중요한 키워드는 **굵게** 표시해주세요.`;
    const analysis = await callGeminiAPI(prompt);
    setModalContent(analysis);
    setIsAiLoading(false);
  };

  const runSimulation = useCallback(() => {
    setIsSimulating(true);
    setSimulationData([]);

    let currentAccounts = JSON.parse(JSON.stringify(config.accounts));
    const results = [];
    const TAXABLE_PENSION_LIMIT = 15000000;
    const PENSION_TAX_RATE = 0.055;
    const MINIMUM_WITHDRAWAL = 10000;
    const SIMULATION_YEARS = 31;
    const annualLivingExpenses = config.monthlyLivingExpenses * 12;

    for (let year = 1; year <= SIMULATION_YEARS; year++) {
      const currentAge = config.startAge + year - 1;
      
      let nationalPensionIncome = 0;
      if (currentAge >= config.nationalPensionStartAge) {
          const yearsReceiving = currentAge - config.nationalPensionStartAge;
          nationalPensionIncome = (config.nationalPensionMonthlyAmount * 12) * Math.pow(1 + config.inflationRate / 100, yearsReceiving);
      }
      
      const neededFromPrivatePensions = Math.max(0, annualLivingExpenses - nationalPensionIncome);
      let privatePensionWithdrawn = 0;
      let taxableWithdrawn = 0;
      
      const taxableAccounts = currentAccounts.filter(acc => acc.taxStatus === '과세');
      taxableAccounts.forEach(acc => {
        if (acc.balance > 0) {
          const withdrawalAmount = Math.min(MINIMUM_WITHDRAWAL, acc.balance);
          acc.balance -= withdrawalAmount;
          privatePensionWithdrawn += withdrawalAmount;
          taxableWithdrawn += withdrawalAmount;
        }
      });

      let remainingNeeded = neededFromPrivatePensions - privatePensionWithdrawn;
      if (remainingNeeded < 0) remainingNeeded = 0;

      const nonTaxableAccounts = currentAccounts.filter(acc => acc.taxStatus === '비과세');
      nonTaxableAccounts.forEach(acc => {
          if(remainingNeeded > 0 && acc.balance > 0){
              const fromNonTaxable = Math.min(remainingNeeded, acc.balance);
              acc.balance -= fromNonTaxable;
              privatePensionWithdrawn += fromNonTaxable;
              remainingNeeded -= fromNonTaxable;
          }
      });
      
      if (remainingNeeded > 0) {
        const availableTaxableLimit = TAXABLE_PENSION_LIMIT - taxableWithdrawn;
        let additionalTaxableWithdrawal = Math.min(remainingNeeded, availableTaxableLimit);
        if(additionalTaxableWithdrawal > 0){
            taxableAccounts.forEach(acc => {
                if(additionalTaxableWithdrawal > 0 && acc.balance > 0){
                    const fromTaxable = Math.min(additionalTaxableWithdrawal, acc.balance);
                    acc.balance -= fromTaxable;
                    privatePensionWithdrawn += fromTaxable;
                    taxableWithdrawn += fromTaxable;
                    additionalTaxableWithdrawal -= fromTaxable;
                }
            });
        }
      }
      
      const taxPaidThisYear = taxableWithdrawn * PENSION_TAX_RATE;
      const taxableBalance = currentAccounts.filter(a => a.taxStatus === '과세').reduce((sum, acc) => sum + acc.balance, 0);
      const nonTaxableBalance = currentAccounts.filter(a => a.taxStatus === '비과세').reduce((sum, acc) => sum + acc.balance, 0);
      
      results.push({
        year, age: currentAge, totalIncome: Math.round(privatePensionWithdrawn + nationalPensionIncome),
        nationalPensionIncome: Math.round(nationalPensionIncome), privatePensionWithdrawn: Math.round(privatePensionWithdrawn),
        taxPaid: Math.round(taxPaidThisYear), totalBalance: Math.round(taxableBalance + nonTaxableBalance),
        taxableBalance: Math.round(taxableBalance), nonTaxableBalance: Math.round(nonTaxableBalance),
      });

      if ((taxableBalance + nonTaxableBalance) <= 0 && neededFromPrivatePensions > privatePensionWithdrawn) break;
    }

    setTimeout(() => {
        setSimulationData(results);
        setIsSimulating(false);
    }, 500);
  }, [config]);

  const resetSimulation = useCallback(() => {
    setConfig(initialConfig);
    setSimulationData([]);
  }, []);

  const summaryData = useMemo(() => {
    if (simulationData.length === 0) return null;
    const totalPrivateWithdrawn = simulationData.reduce((sum, row) => sum + row.privatePensionWithdrawn, 0);
    const totalNationalPension = simulationData.reduce((sum, row) => sum + row.nationalPensionIncome, 0);
    const totalTax = simulationData.reduce((sum, row) => sum + row.taxPaid, 0);
    const finalBalance = simulationData.length > 0 ? simulationData[simulationData.length - 1].totalBalance : 0;
    return { totalPrivateWithdrawn, totalNationalPension, totalTax, finalBalance };
  }, [simulationData]);

  return (
    <div className="bg-gray-100 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
      <AiModal 
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        title={modalTitle}
        content={modalContent}
        isLoading={isAiLoading}
      />
      <div className="max-w-7xl mx-auto">
        <header className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900">✨ AI 은퇴 설계 시뮬레이터</h1>
          <p className="mt-2 text-md text-gray-600">
            물가상승률을 반영한 국민연금과 나의 생활비 계획을 통합하여, 최적의 은퇴 로드맵을 설계하세요.
          </p>
        </header>

        <main>
          <InputForm 
            config={config}
            setConfig={setConfig}
            runSimulation={runSimulation}
            resetSimulation={resetSimulation}
            isSimulating={isSimulating}
            onLifestyleSuggest={handleLifestyleSuggest}
          />

          {isSimulating && <div className="text-center py-10">
            <p className="text-indigo-600 font-semibold">최적의 은퇴자금 계획을 계산하고 있습니다...</p>
          </div>}

          {simulationData.length > 0 && (
            <div className="mt-8">
              <Summary summaryData={summaryData} onAnalysisSuggest={handleAnalysisSuggest} />
              <IncomeCompositionChart data={simulationData} />
              <AssetChart data={simulationData} />
              <ResultTable data={simulationData} />
            </div>
          )}
        </main>
      </div>
    </div>
  );
}

