import React, { useState, useMemo, useCallback } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } from 'recharts';

// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
const formatNumber = (num) => {
  if (typeof num !== 'number') return num;
  return new Intl.NumberFormat('ko-KR').format(num);
};

const parseNumber = (str) => {
  if (typeof str === 'number') return str;
  const parsed = Number(String(str).replace(/,/g, ''));
  return isNaN(parsed) ? 0 : parsed;
};

// --- ì»´í¬ë„ŒíŠ¸ ì •ì˜ ---

// AI ê¸°ëŠ¥ ë¡œë”© ë° ê²°ê³¼ í‘œì‹œë¥¼ ìœ„í•œ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
const AiModal = ({ isOpen, onClose, title, content, isLoading }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div className="p-6 overflow-y-auto">
                    {isLoading ? (
                        <div className="flex flex-col items-center justify-center h-48">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                            <p className="mt-4 text-gray-600">AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    ) : (
                        <div className="text-gray-700 whitespace-pre-wrap leading-relaxed" dangerouslySetInnerHTML={{ __html: content }}></div>
                    )}
                </div>
                <div className="p-4 bg-gray-50 border-t rounded-b-xl text-right">
                    <button onClick={onClose} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    );
};


const InfoCard = ({ title, value, unit = 'ì›', color = 'text-gray-900' }) => (
  <div className="bg-white p-4 rounded-lg shadow">
    <h3 className="text-sm font-medium text-gray-500">{title}</h3>
    <p className={`mt-1 text-2xl font-bold ${color}`}>
      {formatNumber(value)} <span className="text-base font-normal">{unit}</span>
    </p>
  </div>
);

const InputForm = ({ config, setConfig, runSimulation, resetSimulation, isSimulating, onLifestyleSuggest }) => {
    
    const handleAccountChange = (id, field, value) => {
       setConfig(prev => ({
           ...prev,
           accounts: prev.accounts.map(acc =>
               acc.id === id ? { ...acc, [field]: value } : acc
           )
       }));
    };
    
    const addAccount = () => {
        if (config.accounts.length < 5) {
            const newAccount = { id: Date.now(), name: `ì‹ ê·œ ì—°ê¸ˆ ${config.accounts.length + 1}`, type: 'ê°œì¸ì—°ê¸ˆ', taxStatus: 'ê³¼ì„¸', balance: 0 };
            setConfig(prev => ({ ...prev, accounts: [...prev.accounts, newAccount] }));
        }
    };

    const removeAccount = (id) => {
        setConfig(prev => ({ ...prev, accounts: prev.accounts.filter(acc => acc.id !== id) }));
    };

    const handleConfigChange = (e) => {
        const { name, value } = e.target;
        setConfig(prev => ({ ...prev, [name]: parseNumber(value) }));
    };

    return (
        <div className="space-y-6">
            <div className="bg-gray-50 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-gray-800 mb-4">1. ì‚¬ì ì—°ê¸ˆ ì •ë³´ ì…ë ¥ (ìµœëŒ€ 5ê°œ)</h2>
                <div className="space-y-4">
                    {config.accounts.map((account) => (
                        <div key={account.id} className="flex flex-col md:flex-row items-center gap-3 p-3 bg-white rounded-lg border">
                            <div className="w-full flex-grow grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                                <input type="text" value={account.name} onChange={(e) => handleAccountChange(account.id, 'name', e.target.value)} placeholder="ê³„ì¢Œ ë³„ì¹­" className="p-2 border-gray-300 rounded-md"/>
                                 <select value={account.type} onChange={(e) => handleAccountChange(account.id, 'type', e.target.value)} className="p-2 border-gray-300 rounded-md bg-white">
                                    <option>ê°œì¸ì—°ê¸ˆ</option>
                                    <option>í‡´ì§ì—°ê¸ˆ/IRP</option>
                                    <option>ì—°ê¸ˆë³´í—˜</option>
                                    <option>ê¸°íƒ€</option>
                                </select>
                                 <select value={account.taxStatus} onChange={(e) => handleAccountChange(account.id, 'taxStatus', e.target.value)} className="p-2 border-gray-300 rounded-md bg-white">
                                    <option value="ê³¼ì„¸">ê³¼ì„¸</option>
                                    <option value="ë¹„ê³¼ì„¸">ë¹„ê³¼ì„¸</option>
                                </select>
                                <div className="relative rounded-md shadow-sm">
                                    <input type="text" value={formatNumber(account.balance)} onChange={(e) => handleAccountChange(account.id, 'balance', parseNumber(e.target.value))} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                                    <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">ì›</span></div>
                                </div>
                            </div>
                           {config.accounts.length > 1 && (
                               <button 
                                   onClick={() => removeAccount(account.id)} 
                                   className="w-full md:w-auto flex-shrink-0 px-4 py-2 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600 transition-colors"
                               >
                                   ì‚­ì œ
                               </button>
                           )}
                        </div>
                    ))}
                </div>
                {config.accounts.length < 5 && <button onClick={addAccount} className="mt-4 px-4 py-2 text-sm font-semibold text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200">+ ì—°ê¸ˆ ì¶”ê°€í•˜ê¸°</button>}
            </div>

            <div className="bg-gray-50 p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-gray-800 mb-4">2. ì€í‡´ ê³„íš ìƒì„¸ ì„¤ì •</h2>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label htmlFor="monthlyLivingExpenses" className="block text-sm font-medium text-gray-700">í¬ë§ ì›” ìƒí™œë¹„</label>
                        <div className="mt-1 flex items-center gap-2">
                            <div className="relative rounded-md shadow-sm flex-grow">
                                <input type="text" name="monthlyLivingExpenses" id="monthlyLivingExpenses" value={formatNumber(config.monthlyLivingExpenses)} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                                <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">ì›</span></div>
                            </div>
                            <button onClick={onLifestyleSuggest} title="AI ë¼ì´í”„ìŠ¤íƒ€ì¼ ì œì•ˆë°›ê¸°" className="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors">âœ¨</button>
                        </div>
                    </div>
                     <div>
                       <label htmlFor="inflationRate" className="block text-sm font-medium text-gray-700">ì˜ˆìƒ ë¬¼ê°€ìƒìŠ¹ë¥ </label>
                       <div className="mt-1 relative rounded-md shadow-sm">
                            <input type="text" name="inflationRate" id="inflationRate" value={config.inflationRate} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                           <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">%</span></div>
                       </div>
                    </div>
                    <div>
                       <label htmlFor="nationalPensionStartAge" className="block text-sm font-medium text-gray-700">êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ ì‹œì‘ ë‚˜ì´</label>
                       <div className="mt-1 relative rounded-md shadow-sm">
                            <input type="text" name="nationalPensionStartAge" id="nationalPensionStartAge" value={formatNumber(config.nationalPensionStartAge)} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                           <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">ì„¸</span></div>
                       </div>
                    </div>
                    <div>
                       <label htmlFor="nationalPensionMonthlyAmount" className="block text-sm font-medium text-gray-700">êµ­ë¯¼ì—°ê¸ˆ ì›” ì˜ˆìƒ ìˆ˜ë ¹ì•¡ (í˜„ì¬ê°€ì¹˜)</label>
                       <div className="mt-1 relative rounded-md shadow-sm">
                            <input type="text" name="nationalPensionMonthlyAmount" id="nationalPensionMonthlyAmount" value={formatNumber(config.nationalPensionMonthlyAmount)} onChange={handleConfigChange} className="w-full pl-3 pr-12 py-2 border-gray-300 rounded-md"/>
                           <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span className="text-gray-500 sm:text-sm">ì›</span></div>
                       </div>
                    </div>
                 </div>
            </div>
            
            <div className="mt-6 flex items-center justify-end gap-x-4">
                <button type="button" onClick={resetSimulation} className="px-4 py-2 text-sm font-semibold text-gray-700 bg-white rounded-md shadow-sm hover:bg-gray-100 border border-gray-300">ì´ˆê¸°í™”</button>
                <button type="button" onClick={runSimulation} disabled={isSimulating} className="px-6 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300">
                    {isSimulating ? 'ê³„ì‚° ì¤‘...' : 'ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘'}
                </button>
            </div>
        </div>
    );
};


const Summary = ({ summaryData, onAnalysisSuggest }) => {
  if (!summaryData) return null;
  return (
    <div className="mt-8">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-gray-800">ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ìš”ì•½</h2>
        <button onClick={onAnalysisSuggest} className="flex items-center gap-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors text-sm font-semibold">
            âœ¨ AI ì¢…í•© ë¶„ì„ ë° ì½”ì¹­
        </button>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <InfoCard title="ì´ ì‚¬ì ì—°ê¸ˆ ì¸ì¶œì•¡" value={summaryData.totalPrivateWithdrawn} unit="ì›" />
        <InfoCard title="ì´ êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ì•¡ (ë¬¼ê°€ìƒìŠ¹ ë°˜ì˜)" value={summaryData.totalNationalPension} unit="ì›" />
        <InfoCard title="ì‚¬ì ì—°ê¸ˆ ë‚©ë¶€ ì„¸ê¸ˆ" value={summaryData.totalTax} unit="ì›" color="text-red-600" />
        <InfoCard title="31ë…„ í›„ ìµœì¢… ì”ì•¡" value={summaryData.finalBalance} unit="ì›" color="text-indigo-600" />
      </div>
       <div className="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-800 rounded-r-lg">
        <p className="font-bold">ì¢…í•© ì€í‡´ìê¸ˆ ì„¤ê³„ ì „ëµ</p>
        <p className="text-sm">
          êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ ì „ì—ëŠ” ì‚¬ì ì—°ê¸ˆì„ í™œìš©í•˜ê³ , ìˆ˜ë ¹ í›„ì—ëŠ” ë¬¼ê°€ìƒìŠ¹ë¥ ì´ ë°˜ì˜ëœ êµ­ë¯¼ì—°ê¸ˆì„ ì£¼ëœ í˜„ê¸ˆíë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì‚¬ì ì—°ê¸ˆ ì¸ì¶œì„ ìµœì†Œí™”í•¨ìœ¼ë¡œì¨ ìì‚° ìˆ˜ëª…ì„ ì—°ì¥í•˜ê³  ì ˆì„¸ íš¨ê³¼ë¥¼ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  );
};

const IncomeCompositionChart = ({ data }) => {
    if (!data || data.length === 0) return null;
    return (
        <div className="mt-8">
            <h2 className="text-xl font-bold text-gray-800 mb-4">ğŸ“ˆ ì—°ì°¨ë³„ ì´ ìƒí™œë¹„ êµ¬ì„±</h2>
            <div className="bg-white p-4 rounded-xl shadow-lg w-full h-80">
                <ResponsiveContainer>
                    <BarChart data={data} stackOffset="sign" margin={{ top: 20, right: 20, left: 30, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="age" label={{ value: 'ë‚˜ì´', position: 'insideBottom', offset: -5 }} />
                        <YAxis tickFormatter={(value) => `${formatNumber(value/10000)}ë§Œ`} label={{ value: 'ê¸ˆì•¡(ì›)', angle: -90, position: 'insideLeft', offset: -20 }}/>
                        <Tooltip formatter={(value) => `${formatNumber(value)} ì›`} />
                        <Legend verticalAlign="top" height={36}/>
                        <Bar dataKey="privatePensionWithdrawn" stackId="a" fill="#8884d8" name="ì‚¬ì ì—°ê¸ˆ ì¸ì¶œì•¡" />
                        <Bar dataKey="nationalPensionIncome" stackId="a" fill="#82ca9d" name="êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ì•¡" />
                    </BarChart>
                </ResponsiveContainer>
            </div>
        </div>
    );
};

const AssetChart = ({ data }) => {
  if (!data || data.length === 0) return null;
  return (
    <div className="mt-8">
        <h2 className="text-xl font-bold text-gray-800 mb-4">ğŸ“‰ ì—°ì°¨ë³„ ì‚¬ì ì—°ê¸ˆ ìì‚° ë³€í™”</h2>
        <div className="bg-white p-4 rounded-xl shadow-lg w-full h-80">
            <ResponsiveContainer>
                <AreaChart data={data} margin={{ top: 5, right: 20, left: 30, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="age" label={{ value: 'ë‚˜ì´', position: 'insideBottom', offset: -5 }} />
                    <YAxis tickFormatter={(value) => `${formatNumber(value/10000)}ë§Œ`} label={{ value: 'ê¸ˆì•¡(ì›)', angle: -90, position: 'insideLeft', offset: -20 }} />
                    <Tooltip formatter={(value) => `${formatNumber(value)} ì›`} />
                    <Legend verticalAlign="top" height={36}/>
                    <Area type="monotone" dataKey="nonTaxableBalance" stackId="1" stroke="#82ca9d" fill="#82ca9d" name="ë¹„ê³¼ì„¸ ì—°ê¸ˆ" />
                    <Area type="monotone" dataKey="taxableBalance" stackId="1" stroke="#8884d8" fill="#8884d8" name="ê³¼ì„¸ ì—°ê¸ˆ" />
                </AreaChart>
            </ResponsiveContainer>
        </div>
    </div>
  );
};

const ResultTable = ({ data }) => {
  if (!data || data.length === 0) return null;
  return (
    <div className="mt-8">
      <h2 className="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ì—°ì°¨ë³„ ìƒì„¸ ë‚´ì—­</h2>
      <div className="overflow-x-auto bg-white rounded-xl shadow-lg">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚˜ì´</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì´ ìƒí™œë¹„</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">êµ­ë¯¼ì—°ê¸ˆ</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‚¬ì ì—°ê¸ˆ ì¸ì¶œ</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚©ë¶€ ì„¸ê¸ˆ</th>
              <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì—°ë§ ì´ ì”ì•¡</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {data.map((row) => (
              <tr key={row.year} className="hover:bg-gray-50">
                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{row.age}ì„¸</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-700">{formatNumber(row.totalIncome)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-green-700">{formatNumber(row.nationalPensionIncome)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-blue-700">{formatNumber(row.privatePensionWithdrawn)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm text-red-600">{formatNumber(row.taxPaid)}</td>
                <td className="px-4 py-4 whitespace-nowrap text-sm font-semibold text-indigo-700">{formatNumber(row.totalBalance)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};


// ë©”ì¸ ì•± ì»´í¬ë„ŒíŠ¸
export default function App() {
  const initialConfig = {
    accounts: [
        { id: 1, name: 'ê°œì¸ì—°ê¸ˆ #01', type: 'ê°œì¸ì—°ê¸ˆ', taxStatus: 'ê³¼ì„¸', balance: 121000000 },
        { id: 2, name: 'ê°œì¸ì—°ê¸ˆ #02', type: 'ê°œì¸ì—°ê¸ˆ', taxStatus: 'ê³¼ì„¸', balance: 80000000 },
        { id: 3, name: 'ê°œì¸ì—°ê¸ˆ #03 (ISAì „í™˜)', type: 'ê°œì¸ì—°ê¸ˆ', taxStatus: 'ë¹„ê³¼ì„¸', balance: 102000000 },
        { id: 4, name: 'IRP', type: 'í‡´ì§ì—°ê¸ˆ/IRP', taxStatus: 'ê³¼ì„¸', balance: 51000000 },
    ],
    monthlyLivingExpenses: 2100000,
    startAge: 55,
    nationalPensionStartAge: 65,
    nationalPensionMonthlyAmount: 1800000,
    inflationRate: 2.8,
  };

  const [config, setConfig] = useState(initialConfig);
  const [simulationData, setSimulationData] = useState([]);
  const [isSimulating, setIsSimulating] = useState(false);
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalTitle, setModalTitle] = useState('');
  const [modalContent, setModalContent] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);

  const callGeminiAPI = async (prompt) => {
    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
    try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
            let text = result.candidates[0].content.parts[0].text;
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            return text;
        } else { return "AIë¡œë¶€í„° ë‹µë³€ì„ ë°›ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."; }
    } catch (error) {
        console.error("Gemini API Error:", error);
        return "AI ê¸°ëŠ¥ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    }
  };

  const handleLifestyleSuggest = async () => {
    setModalTitle("âœ¨ AI ë¼ì´í”„ìŠ¤íƒ€ì¼ ì œì•ˆ");
    setModalContent('');
    setIsAiLoading(true);
    setIsModalOpen(true);
    const prompt = `ëŒ€í•œë¯¼êµ­ì—ì„œ ì€í‡´ë¥¼ ì•ë‘” ì‚¬ëŒì´ í¬ë§ ì›” ìƒí™œë¹„ë¡œ ${formatNumber(config.monthlyLivingExpenses)}ì›ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ì´ ì˜ˆì‚°ìœ¼ë¡œ ëˆ„ë¦´ ìˆ˜ ìˆëŠ” í’ìš”ë¡­ê³  í˜„ì‹¤ì ì¸ ì€í‡´ í›„ ë¼ì´í”„ìŠ¤íƒ€ì¼ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”. ì·¨ë¯¸, ì—¬ê°€, ì‚¬íšŒ í™œë™, ê±´ê°• ê´€ë¦¬, ìê¸° ê³„ë°œ ë“± ë‹¤ì–‘í•œ ì¸¡ë©´ì„ í¬í•¨í•˜ì—¬ ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ì–´ì¡°ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ì‘ë‹µì€ í•œêµ­ì–´ë¡œ í•´ì£¼ì„¸ìš”. ì¤‘ìš”í•œ í‚¤ì›Œë“œëŠ” **êµµê²Œ** í‘œì‹œí•´ì£¼ì„¸ìš”.`;
    const suggestion = await callGeminiAPI(prompt);
    setModalContent(suggestion);
    setIsAiLoading(false);
  };

  const handleAnalysisSuggest = async () => {
    if (simulationData.length === 0) return;
    setModalTitle("âœ¨ AI ì¢…í•© ë¶„ì„ ë° ì½”ì¹­");
    setModalContent('');
    setIsAiLoading(true);
    setIsModalOpen(true);
    const summary = summaryData;
    const prompt = `ì€í‡´ ì„¤ê³„ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ì…ë‹ˆë‹¤. ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì „ë¬¸ ì€í‡´ ì»¨ì„¤í„´íŠ¸ì˜ ì…ì¥ì—ì„œ ì¢…í•©ì ì¸ ë¶„ì„ê³¼ ë”°ëœ»í•œ ì½”ì¹­ì„ ì œê³µí•´ì£¼ì„¸ìš”.\n\n**ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼:**\n- ì´ ì‚¬ì ì—°ê¸ˆ ì¸ì¶œì•¡: ${formatNumber(summary.totalPrivateWithdrawn)}ì›\n- ì´ êµ­ë¯¼ì—°ê¸ˆ ìˆ˜ë ¹ì•¡: ${formatNumber(summary.totalNationalPension)}ì›\n- 31ë…„ í›„ ìµœì¢… ì”ì•¡: ${formatNumber(summary.finalBalance)}ì›\n- í¬ë§ ì›” ìƒí™œë¹„ (ì´ˆê¸°): ${formatNumber(config.monthlyLivingExpenses)}ì›\n\n**ë¶„ì„ ë° ì½”ì¹­ ê°€ì´ë“œë¼ì¸:**\n1.  **ê²°ê³¼ ìš”ì•½:** ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ ê¸ì •ì ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.\n2.  **ê°•ì  ë¶„ì„:** ì´ ê³„íšì˜ ê°•ì ì„ ì§šì–´ì£¼ì„¸ìš”. (ì˜ˆ: êµ­ë¯¼ì—°ê¸ˆê³¼ ì‚¬ì ì—°ê¸ˆì˜ ì¡°í™”, ë¹„ê³¼ì„¸ ìì‚° í™œìš© ë“±)\n3.  **ê³ ë ¤ì‚¬í•­ ë° ì œì•ˆ:** ìµœì¢… ì”ì•¡ì„ ê¸°ì¤€ìœ¼ë¡œ, ìê¸ˆì´ ë¶€ì¡±í•˜ë‹¤ë©´ ë¶€ë“œëŸ½ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ëŒ€ì•ˆ(ì˜ˆ: ì†Œë¹„ ì¡°ì •, ì¶”ê°€ ìˆ˜ì…ì› íƒìƒ‰)ì„ ì œì‹œí•˜ê³ , ìê¸ˆì´ ì¶©ë¶„í•˜ë‹¤ë©´ ì‚¶ì˜ ì§ˆì„ ë†’ì¼ ìˆ˜ ìˆëŠ” ë°©ì•ˆ(ì˜ˆ: ë²„í‚·ë¦¬ìŠ¤íŠ¸ ì‹¤í˜„, ìƒì†/ì¦ì—¬ ê³„íš)ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.\n4.  **ê²©ë ¤ ë©”ì‹œì§€:** ì„±ê³µì ì¸ ì€í‡´ ì¤€ë¹„ë¥¼ ê²©ë ¤í•˜ëŠ” í¬ë§ì ì¸ ë©”ì‹œì§€ë¡œ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”.\n\nì „ì²´ì ìœ¼ë¡œ ê¸ì •ì ì´ê³  ì§€ì§€í•˜ëŠ” í†¤ì„ ìœ ì§€í•˜ë©°, ì‘ë‹µì€ í•œêµ­ì–´ë¡œ í•´ì£¼ì„¸ìš”. ì¤‘ìš”í•œ í‚¤ì›Œë“œëŠ” **êµµê²Œ** í‘œì‹œí•´ì£¼ì„¸ìš”.`;
    const analysis = await callGeminiAPI(prompt);
    setModalContent(analysis);
    setIsAiLoading(false);
  };

  const runSimulation = useCallback(() => {
    setIsSimulating(true);
    setSimulationData([]);

    let currentAccounts = JSON.parse(JSON.stringify(config.accounts));
    const results = [];
    const TAXABLE_PENSION_LIMIT = 15000000;
    const PENSION_TAX_RATE = 0.055;
    const MINIMUM_WITHDRAWAL = 10000;
    const SIMULATION_YEARS = 31;
    const annualLivingExpenses = config.monthlyLivingExpenses * 12;

    for (let year = 1; year <= SIMULATION_YEARS; year++) {
      const currentAge = config.startAge + year - 1;
      
      let nationalPensionIncome = 0;
      if (currentAge >= config.nationalPensionStartAge) {
          const yearsReceiving = currentAge - config.nationalPensionStartAge;
          nationalPensionIncome = (config.nationalPensionMonthlyAmount * 12) * Math.pow(1 + config.inflationRate / 100, yearsReceiving);
      }
      
      const neededFromPrivatePensions = Math.max(0, annualLivingExpenses - nationalPensionIncome);
      let privatePensionWithdrawn = 0;
      let taxableWithdrawn = 0;
      
      const taxableAccounts = currentAccounts.filter(acc => acc.taxStatus === 'ê³¼ì„¸');
      taxableAccounts.forEach(acc => {
        if (acc.balance > 0) {
          const withdrawalAmount = Math.min(MINIMUM_WITHDRAWAL, acc.balance);
          acc.balance -= withdrawalAmount;
          privatePensionWithdrawn += withdrawalAmount;
          taxableWithdrawn += withdrawalAmount;
        }
      });

      let remainingNeeded = neededFromPrivatePensions - privatePensionWithdrawn;
      if (remainingNeeded < 0) remainingNeeded = 0;

      const nonTaxableAccounts = currentAccounts.filter(acc => acc.taxStatus === 'ë¹„ê³¼ì„¸');
      nonTaxableAccounts.forEach(acc => {
          if(remainingNeeded > 0 && acc.balance > 0){
              const fromNonTaxable = Math.min(remainingNeeded, acc.balance);
              acc.balance -= fromNonTaxable;
              privatePensionWithdrawn += fromNonTaxable;
              remainingNeeded -= fromNonTaxable;
          }
      });
      
      if (remainingNeeded > 0) {
        const availableTaxableLimit = TAXABLE_PENSION_LIMIT - taxableWithdrawn;
        let additionalTaxableWithdrawal = Math.min(remainingNeeded, availableTaxableLimit);
        if(additionalTaxableWithdrawal > 0){
            taxableAccounts.forEach(acc => {
                if(additionalTaxableWithdrawal > 0 && acc.balance > 0){
                    const fromTaxable = Math.min(additionalTaxableWithdrawal, acc.balance);
                    acc.balance -= fromTaxable;
                    privatePensionWithdrawn += fromTaxable;
                    taxableWithdrawn += fromTaxable;
                    additionalTaxableWithdrawal -= fromTaxable;
                }
            });
        }
      }
      
      const taxPaidThisYear = taxableWithdrawn * PENSION_TAX_RATE;
      const taxableBalance = currentAccounts.filter(a => a.taxStatus === 'ê³¼ì„¸').reduce((sum, acc) => sum + acc.balance, 0);
      const nonTaxableBalance = currentAccounts.filter(a => a.taxStatus === 'ë¹„ê³¼ì„¸').reduce((sum, acc) => sum + acc.balance, 0);
      
      results.push({
        year, age: currentAge, totalIncome: Math.round(privatePensionWithdrawn + nationalPensionIncome),
        nationalPensionIncome: Math.round(nationalPensionIncome), privatePensionWithdrawn: Math.round(privatePensionWithdrawn),
        taxPaid: Math.round(taxPaidThisYear), totalBalance: Math.round(taxableBalance + nonTaxableBalance),
        taxableBalance: Math.round(taxableBalance), nonTaxableBalance: Math.round(nonTaxableBalance),
      });

      if ((taxableBalance + nonTaxableBalance) <= 0 && neededFromPrivatePensions > privatePensionWithdrawn) break;
    }

    setTimeout(() => {
        setSimulationData(results);
        setIsSimulating(false);
    }, 500);
  }, [config]);

  const resetSimulation = useCallback(() => {
    setConfig(initialConfig);
    setSimulationData([]);
  }, []);

  const summaryData = useMemo(() => {
    if (simulationData.length === 0) return null;
    const totalPrivateWithdrawn = simulationData.reduce((sum, row) => sum + row.privatePensionWithdrawn, 0);
    const totalNationalPension = simulationData.reduce((sum, row) => sum + row.nationalPensionIncome, 0);
    const totalTax = simulationData.reduce((sum, row) => sum + row.taxPaid, 0);
    const finalBalance = simulationData.length > 0 ? simulationData[simulationData.length - 1].totalBalance : 0;
    return { totalPrivateWithdrawn, totalNationalPension, totalTax, finalBalance };
  }, [simulationData]);

  return (
    <div className="bg-gray-100 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
      <AiModal 
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        title={modalTitle}
        content={modalContent}
        isLoading={isAiLoading}
      />
      <div className="max-w-7xl mx-auto">
        <header className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900">âœ¨ AI ì€í‡´ ì„¤ê³„ ì‹œë®¬ë ˆì´í„°</h1>
          <p className="mt-2 text-md text-gray-600">
            ë¬¼ê°€ìƒìŠ¹ë¥ ì„ ë°˜ì˜í•œ êµ­ë¯¼ì—°ê¸ˆê³¼ ë‚˜ì˜ ìƒí™œë¹„ ê³„íšì„ í†µí•©í•˜ì—¬, ìµœì ì˜ ì€í‡´ ë¡œë“œë§µì„ ì„¤ê³„í•˜ì„¸ìš”.
          </p>
        </header>

        <main>
          <InputForm 
            config={config}
            setConfig={setConfig}
            runSimulation={runSimulation}
            resetSimulation={resetSimulation}
            isSimulating={isSimulating}
            onLifestyleSuggest={handleLifestyleSuggest}
          />

          {isSimulating && <div className="text-center py-10">
            <p className="text-indigo-600 font-semibold">ìµœì ì˜ ì€í‡´ìê¸ˆ ê³„íšì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
          </div>}

          {simulationData.length > 0 && (
            <div className="mt-8">
              <Summary summaryData={summaryData} onAnalysisSuggest={handleAnalysisSuggest} />
              <IncomeCompositionChart data={simulationData} />
              <AssetChart data={simulationData} />
              <ResultTable data={simulationData} />
            </div>
          )}
        </main>
      </div>
    </div>
  );
}

