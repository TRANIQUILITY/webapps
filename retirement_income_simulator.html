<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>은퇴 소득 통합 시뮬레이터 8.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
        }
        .tab-button {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #2563eb;
            font-weight: 700;
        }
        .input-label {
            font-weight: 500;
            color: #374151;
        }
        .info-container {
            position: relative;
            display: inline-block;
        }
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            border-radius: 50%;
            background-color: #9ca3af;
            color: white;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            margin-left: 4px;
        }
        .tooltip {
            visibility: hidden;
            width: 260px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -130px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .info-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .output-label {
            font-weight: 500;
            color: #1f2937;
        }
        .output-value {
            font-weight: 700;
            color: #1d4ed8;
        }
        .warning {
            color: #ef4444;
            font-weight: 700;
        }
        .safe {
            color: #22c55e;
            font-weight: 700;
        }
        .number-input {
            text-align: right;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .action-button {
            transition: all 0.2s ease-in-out;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">은퇴 소득 통합 시뮬레이터 8.0</h1>
            <p class="mt-3 text-md text-gray-600 max-w-3xl mx-auto">
                본 시뮬레이터는 '1인 투자 법인 설립', '개인 임대사업', '개인 투자'를 병행하는 은퇴 모델을 기반으로<br>
                각 소득원의 상호작용과 세금, 장기 자산 성장을 종합적으로 분석하고 예측합니다.
            </p>
        </header>
        
        <div id="statusMessage" class="text-center text-sm text-green-600 h-6 mb-2"></div>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex justify-center -mb-px space-x-6">
                <button class="tab-button active py-4 px-1 text-lg" onclick="changeTab(event, 'simulator')">통합 시뮬레이터</button>
                <button class="tab-button py-4 px-1 text-lg" onclick="changeTab(event, 'dashboard')">포트폴리오 대시보드</button>
                <button class="tab-button py-4 px-1 text-lg" onclick="changeTab(event, 'projection')">25년 장기 전망</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="simulator" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 입력 섹션 -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-6 border-b pb-3">
                        <h2 class="text-2xl font-bold text-gray-800">1. 조건 입력</h2>
                        <div class="flex items-center space-x-2">
                            <select id="scenarioSlot" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="1">시나리오 1</option>
                                <option value="2">시나리오 2</option>
                                <option value="3">시나리오 3</option>
                                <option value="4">시나리오 4</option>
                                <option value="5">시나리오 5</option>
                            </select>
                            <button id="saveButton" class="action-button bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-semibold shadow-md">저장</button>
                            <button id="loadButton" class="action-button bg-gray-500 text-white px-3 py-2 rounded-lg text-sm font-semibold shadow-md">불러오기</button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-blue-700 mb-3">1-1. 1인 투자 법인 설정</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="corpCapital" class="input-label">총 운용자금 (가수금)</label>
                                <div class="flex items-center space-x-2"><input type="text" id="corpCapital" value="1,200,000,000" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"><span id="corpCapitalKorean" class="text-sm text-gray-500 font-semibold w-28 text-right"></span></div>
                            </div>
                            <div><label for="corpRoi" class="input-label">연평균 투자 수익률 (%)</label><input type="number" id="corpRoi" value="5" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"></div>
                            <div>
                                <label for="ceoSalary" class="input-label">대표 급여 (월)</label>
                                <div class="flex items-center space-x-2"><input type="text" id="ceoSalary" value="3,000,000" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"><span id="ceoSalaryKorean" class="text-sm text-gray-500 font-semibold w-28 text-right"></span></div>
                            </div>
                            <div>
                                <label for="taxServiceFee" class="input-label">세무기장료 (연)</label>
                                <div class="flex items-center space-x-2"><input type="text" id="taxServiceFee" value="2,400,000" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"><span id="taxServiceFeeKorean" class="text-sm text-gray-500 font-semibold w-28 text-right"></span></div>
                            </div>
                            <div>
                                <label for="corpOperatingFee" class="input-label">법인운영비 (연)</label>
                                <div class="flex items-center space-x-2"><input type="text" id="corpOperatingFee" value="5,000,000" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"><span id="corpOperatingFeeKorean" class="text-sm text-gray-500 font-semibold w-28 text-right"></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-green-700 mb-3">1-2. 개인 임대사업 설정</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="officePrice" class="input-label">오피스텔 매입가</label>
                                <div class="flex items-center space-x-2"><input type="text" id="officePrice" value="200,000,000" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"><span id="officePriceKorean" class="text-sm text-gray-500 font-semibold w-28 text-right"></span></div>
                            </div>
                            <div>
                                <label for="rentalYield" class="input-label">연 임대수익률 (%)</label>
                                <input type="number" id="rentalYield" value="4" class="number-input w-full p-2 border rounded-md bg-gray-50">
                            </div>
                            <div>
                                <label for="rentalExpenses" class="input-label">필요경비 (연)</label>
                                <div class="flex items-center space-x-2"><input type="text" id="rentalExpenses" value="1,000,000" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"><span id="rentalExpensesKorean" class="text-sm text-gray-500 font-semibold w-28 text-right"></span></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-purple-700 mb-3">1-3. 개인 금융투자 설정</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="personalInvestCapital" class="input-label">개인 금융 투자 총액</label>
                                <div class="flex items-center space-x-2"><input type="text" id="personalInvestCapital" value="100,000,000" class="number-input mt-1 w-full p-2 border rounded-md bg-gray-50"><span id="personalInvestCapitalKorean" class="text-sm text-gray-500 font-semibold w-28 text-right"></span></div>
                            </div>
                            <div>
                                <label for="personalDividendYield" class="input-label">배당/이자 수익률 (%)</label>
                                <input type="number" id="personalDividendYield" value="3" class="number-input w-full p-2 border rounded-md bg-gray-50">
                            </div>
                            <div>
                                <label for="personalCapitalGainsRoi" class="input-label">자본이득률 (주가 상승분, %)</label>
                                <input type="number" id="personalCapitalGainsRoi" value="4" class="number-input w-full p-2 border rounded-md bg-gray-50">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 결과 섹션 -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-6">
                    <h2 class="text-2xl font-bold border-b pb-3 text-gray-800">2. 시뮬레이션 결과 (연간)</h2>

                    <div>
                        <h3 class="text-xl font-semibold text-blue-700 mb-3">2-1. 법인 재무 분석</h3>
                        <div class="space-y-2 bg-blue-50 p-4 rounded-lg">
                            <div class="flex justify-between"><span class="output-label">총 투자수익</span><span id="corpGrossProfit" class="output-value"></span></div>
                            <div class="flex justify-between text-sm"><span class="output-label pl-4">(-) 대표 급여</span><span id="corpSalaryExpense" class="output-value text-red-600"></span></div>
                            <div class="flex justify-between text-sm"><span class="output-label pl-4">(-) 임대료</span><span id="corpRentalExpense" class="output-value text-red-600"></span></div>
                            <div class="flex justify-between text-sm"><span class="output-label pl-4">(-) 기타 운영비</span><span id="corpOtherExpenses" class="output-value text-red-600"></span></div>
                            <hr class="my-1">
                            <div class="flex justify-between"><span class="output-label">과세표준</span><span id="corpTaxableIncome" class="output-value"></span></div>
                            <div class="flex justify-between"><span class="output-label">법인세</span><span id="corpTax" class="output-value text-red-600"></span></div>
                            <hr class="my-1">
                            <div class="flex justify-between"><span class="output-label font-bold">세후 순이익 (전액 유보)</span><span id="corpNetProfit" class="output-value font-bold text-blue-800"></span></div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">
                            2-2. 개인 종합소득 분석
                            <div class="info-container">
                                <span class="info-icon">?</span>
                                <span class="tooltip">
                                    종합소득세는 여러 소득을 합산하여 계산합니다.
                                    <br><br>
                                    - **A(근로), B(사업)** 소득은 금액과 무관하게 항상 합산됩니다.
                                    <br>
                                    - **C(금융)** 소득은 연 2천만원 이하일 경우 15.4% 분리과세로 종결되며, 2천만원을 초과할 경우 그 '전체' 금액이 A, B 소득과 합산되어 높은 세율(누진세)로 과세됩니다.
                                </span>
                            </div>
                        </h3>
                        <div class="space-y-2 bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between"><span class="output-label">근로소득 (A)</span><span id="personalSalaryIncome" class="output-value"></span></div>
                            <div class="flex justify-between"><span class="output-label">사업소득 (B, 임대)</span><span id="personalRentalIncome" class="output-value"></span></div>
                            <div class="flex justify-between"><span class="output-label">금융소득 (C, 개인투자)</span><span id="personalFinancialIncome" class="output-value"></span></div>
                            <hr class="my-1">
                            <div class="flex justify-between items-center bg-yellow-100 p-2 rounded-md">
                                <div class="flex flex-col"><span class="output-label font-bold">금융소득 (C)</span><span class="text-sm text-gray-500">(2천만원 초과 시 종합과세)</span></div>
                                <span id="personalTotalFinancialIncome" class="output-value text-lg"></span>
                            </div>
                            <div id="tax-warning" class="text-center p-2 rounded-md mt-2"></div>
                        </div>
                    </div>
                    
                    <div>
                         <h3 class="text-xl font-semibold text-gray-800 mb-3">2-3. 연간 성과 요약</h3>
                         <div class="space-y-2 bg-green-50 p-4 rounded-lg">
                            <div class="flex justify-between"><span class="output-label">법인 유보금 (자산증가)</span><span id="corpRetainedEarnings" class="output-value text-green-700"></span></div>
                            <div class="flex justify-between"><span class="output-label">개인 자본이득 (세전)</span><span id="personalCapitalGains" class="output-value text-green-700"></span></div>
                            <div class="flex justify-between"><span class="output-label">개인 순저축액</span><span id="personalNetSavings" class="output-value text-green-700"></span></div>
                            <hr class="my-2 border-t-2 border-green-200">
                            <div class="flex justify-between text-lg">
                                <span class="output-label font-extrabold">총 순자산 증가액 (연)</span>
                                <span id="totalNetAssetGrowth" class="output-value font-extrabold text-green-800"></span>
                            </div>
                         </div>
                    </div>

                     <div>
                         <h3 class="text-xl font-semibold text-gray-800 mb-3">2-4. 개인 급여소득 세부 (월 기준)</h3>
                         <div class="space-y-2 bg-indigo-50 p-4 rounded-lg">
                            <div class="flex justify-between"><span class="output-label">급여</span><span id="monthlyGrossSalary" class="output-value text-indigo-700"></span></div>
                            <div class="flex justify-between text-sm"><span class="output-label pl-4">(-) 국민연금 (4.5%)</span><span id="monthlyNationalPension" class="output-value text-red-600"></span></div>
                            <div class="flex justify-between text-sm"><span class="output-label pl-4">(-) 건강보험 (3.545%)</span><span id="monthlyHealthInsurance" class="output-value text-red-600"></span></div>
                             <div class="flex justify-between text-sm"><span class="output-label pl-4">(-) 장기요양 (건보료의 12.95%)</span><span id="monthlyLongTermCare" class="output-value text-red-600"></span></div>
                            <div class="flex justify-between text-sm"><span class="output-label pl-4">(-) 고용보험 (0.9%)</span><span id="monthlyEmploymentInsurance" class="output-value text-red-600"></span></div>
                            <hr class="my-1">
                            <div class="flex justify-between">
                                <span class="output-label font-bold">예상 실수령액</span>
                                <div class="info-container">
                                    <span class="info-icon">!</span>
                                    <span class="tooltip">연간 종합소득세는 별도 계산되며, 여기서는 4대보험만 차감한 금액입니다.</span>
                                </div>
                                <span id="monthlyNetSalary" class="output-value font-bold text-indigo-800"></span>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">포트폴리오 대시보드</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div>
                        <canvas id="portfolioChart"></canvas>
                    </div>
                    <div id="portfolioSummary" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <div id="projection" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">25년 장기 성장 전망</h2>
                <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800 space-y-2">
                    <p><strong>가정 1: </strong>4년마다 법인 운용자금(가수금)에서 2억원을 회수하여 개인 금융투자로 이전합니다.</p>
                    <p><strong>그래프 해석 Tip: </strong>가수금 회수 시 법인 자산이 줄어 투자 수익이 고정 비용보다 작아지면, 법인 자산 성장이 둔화되거나 정체될 수 있습니다. 이는 시나리오의 지속가능성을 보여주는 중요한 지표입니다.</p>
                </div>
                <div class="mb-6">
                    <canvas id="projectionChart"></canvas>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="py-3 px-6">연차</th>
                                <th scope="col" class="py-3 px-6">총 자산</th>
                                <th scope="col" class="py-3 px-6">법인 자산</th>
                                <th scope="col" class="py-3 px-6">개인 금융자산</th>
                                <th scope="col" class="py-3 px-6">연간 총소득</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>※ 본 시뮬레이터는 복잡한 세법 및 공과금 규정을 단순화하여 계산한 추정치입니다.</p>
            <p>※ 개인별 상황에 따라 실제 금액과 차이가 있을 수 있으므로, 참고용으로만 활용하시고 실제 실행 전 반드시 세무 전문가와 상담하시기 바랍니다.</p>
        </footer>
    </div>

    <script>
        let portfolioChartInstance, projectionChartInstance;
        let currentScenario = {};

        const elements = {
            corpCapital: document.getElementById('corpCapital'), corpRoi: document.getElementById('corpRoi'),
            ceoSalary: document.getElementById('ceoSalary'), 
            taxServiceFee: document.getElementById('taxServiceFee'), corpOperatingFee: document.getElementById('corpOperatingFee'),
            officePrice: document.getElementById('officePrice'), rentalYield: document.getElementById('rentalYield'),
            rentalExpenses: document.getElementById('rentalExpenses'), personalInvestCapital: document.getElementById('personalInvestCapital'),
            personalDividendYield: document.getElementById('personalDividendYield'), personalCapitalGainsRoi: document.getElementById('personalCapitalGainsRoi'),
            corpGrossProfit: document.getElementById('corpGrossProfit'), corpSalaryExpense: document.getElementById('corpSalaryExpense'),
            corpRentalExpense: document.getElementById('corpRentalExpense'), corpOtherExpenses: document.getElementById('corpOtherExpenses'),
            corpTaxableIncome: document.getElementById('corpTaxableIncome'), corpTax: document.getElementById('corpTax'),
            corpNetProfit: document.getElementById('corpNetProfit'), personalSalaryIncome: document.getElementById('personalSalaryIncome'),
            personalRentalIncome: document.getElementById('personalRentalIncome'), personalFinancialIncome: document.getElementById('personalFinancialIncome'),
            personalTotalFinancialIncome: document.getElementById('personalTotalFinancialIncome'), taxWarning: document.getElementById('tax-warning'),
            corpRetainedEarnings: document.getElementById('corpRetainedEarnings'), personalCapitalGains: document.getElementById('personalCapitalGains'),
            personalNetSavings: document.getElementById('personalNetSavings'), totalNetAssetGrowth: document.getElementById('totalNetAssetGrowth'),
            monthlyGrossSalary: document.getElementById('monthlyGrossSalary'), monthlyNationalPension: document.getElementById('monthlyNationalPension'),
            monthlyHealthInsurance: document.getElementById('monthlyHealthInsurance'), monthlyLongTermCare: document.getElementById('monthlyLongTermCare'),
            monthlyEmploymentInsurance: document.getElementById('monthlyEmploymentInsurance'), monthlyNetSalary: document.getElementById('monthlyNetSalary'),
            portfolioSummary: document.getElementById('portfolioSummary'), projectionTableBody: document.getElementById('projectionTableBody'),
            scenarioSlot: document.getElementById('scenarioSlot'),
            saveButton: document.getElementById('saveButton'), loadButton: document.getElementById('loadButton'),
            statusMessage: document.getElementById('statusMessage'),
        };
        
        const inputIds = [
            'corpCapital', 'corpRoi', 'ceoSalary', 'taxServiceFee', 'corpOperatingFee',
            'officePrice', 'rentalYield', 'rentalExpenses', 'personalInvestCapital',
            'personalDividendYield', 'personalCapitalGainsRoi'
        ];
        const koreanUnitTargetIds = [
            'corpCapital', 'ceoSalary', 'taxServiceFee', 'corpOperatingFee', 
            'officePrice', 'rentalExpenses', 'personalInvestCapital'
        ];

        const formatKRW = (num) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(Math.round(num));
        const formatNumber = (num) => String(num).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const parseNumber = (str) => parseFloat(String(str).replace(/,/g, '')) || 0;
        
        function toKoreanWon(number) {
            if (isNaN(number) || number === 0) return '';
            let inputNumber = number < 0 ? false : number;
            let unitWords = ['', '만', '억', '조', '경'];
            let splitUnit = 10000;
            let splitCount = unitWords.length;
            let resultArray = [];
            let resultString = '';

            for (let i = 0; i < splitCount; i++) {
                let unitResult = (inputNumber % Math.pow(splitUnit, i + 1)) / Math.pow(splitUnit, i);
                unitResult = Math.floor(unitResult);
                if (unitResult > 0) {
                    resultArray[i] = unitResult;
                }
            }

            for (let i = 0; i < resultArray.length; i++) {
                if (!resultArray[i]) continue;
                resultString = String(formatNumber(resultArray[i])) + unitWords[i] + ' ' + resultString;
            }
            return resultString.trim() + ' 원';
        }

        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('change', () => {
                updateStateFromDom();
                runAllCalculations();
            });
            if (el.classList.contains('number-input')) {
                 el.addEventListener('keyup', (e) => {
                    const value = parseNumber(e.target.value);
                    e.target.value = formatNumber(value);
                    if (koreanUnitTargetIds.includes(id)) {
                        document.getElementById(id + 'Korean').textContent = toKoreanWon(value);
                    }
                 });
            }
        });

        function calculateYear(inputs) {
            const corpGrossProfit = inputs.corpCapital * inputs.corpRoi;
            const corpSalaryExpense = inputs.ceoSalaryMonthly * 12;
            const corpRentalExpense = inputs.officePrice * inputs.rentalYield;
            const corpOtherExpenses = inputs.taxServiceFee + inputs.corpOperatingFee;
            const corpTotalExpenses = corpSalaryExpense + corpRentalExpense + corpOtherExpenses;
            const corpTaxableIncome = Math.max(0, corpGrossProfit - corpTotalExpenses);
            const corpTax = calculateCorporateTax(corpTaxableIncome);
            const corpNetProfit = corpTaxableIncome - corpTax;

            const personalSalaryIncome = corpSalaryExpense;
            const personalRentalBusinessIncome = corpRentalExpense - inputs.rentalExpenses;
            const personalInvestmentDividendIncome = inputs.personalInvestCapital * inputs.personalDividendYield;
            const personalTotalFinancialIncome = personalInvestmentDividendIncome;
            const personalCapitalGains = inputs.personalInvestCapital * inputs.personalCapitalGainsRoi;

            const isFinancialTaxTarget = personalTotalFinancialIncome > 20000000;
            const totalComprehensiveIncomeBase = personalSalaryIncome + personalRentalBusinessIncome;
            const financialIncomeForTax = isFinancialTaxTarget ? personalTotalFinancialIncome : 0;
            const totalComprehensiveIncome = totalComprehensiveIncomeBase + financialIncomeForTax;

            const salaryDeduction = calculateSalaryDeduction(personalSalaryIncome);
            const incomeDeduction = 1500000 + salaryDeduction;
            const finalTaxableIncome = Math.max(0, totalComprehensiveIncome - incomeDeduction);
            const estimatedIncomeTaxOnComprehensive = calculateIncomeTax(finalTaxableIncome);
            const separatedTaxOnFinancial = isFinancialTaxTarget ? 0 : personalTotalFinancialIncome * 0.154;
            const estimatedIncomeTax = estimatedIncomeTaxOnComprehensive + separatedTaxOnFinancial;

            const employeeSalaryInsurance = personalSalaryIncome * 0.03545 * (1 + 0.1295);
            const otherIncomeForInsurance = Math.max(0, personalRentalBusinessIncome + personalTotalFinancialIncome - 20000000);
            const otherIncomeInsurance = otherIncomeForInsurance * 0.0709;
            const estimatedHealthInsurance = employeeSalaryInsurance + otherIncomeInsurance;

            const personalTotalGrossIncome = personalSalaryIncome + personalRentalBusinessIncome + personalTotalFinancialIncome;
            const totalTaxAndDues = estimatedIncomeTax + estimatedHealthInsurance;
            const personalNetIncome = personalTotalGrossIncome - totalTaxAndDues;
            const personalNetSavings = Math.max(0, personalNetIncome - (inputs.ceoSalaryMonthly * 12));
            
            const corpRetainedEarnings = corpNetProfit;
            const totalNetAssetGrowth = corpRetainedEarnings + personalCapitalGains + personalNetSavings;
            
            const monthlyGrossSalary = inputs.ceoSalaryMonthly;
            const pensionableSalary = Math.min(monthlyGrossSalary, 5900000);
            const monthlyNationalPension = pensionableSalary * 0.045;
            const monthlyHealthInsurance = monthlyGrossSalary * 0.03545;
            const monthlyLongTermCare = monthlyHealthInsurance * 0.1295;
            const monthlyEmploymentInsurance = monthlyGrossSalary * 0.009;
            const monthlyDeductions = monthlyNationalPension + monthlyHealthInsurance + monthlyLongTermCare + monthlyEmploymentInsurance;
            const monthlyNetSalary = monthlyGrossSalary - monthlyDeductions;

            return {
                corpGrossProfit, corpSalaryExpense, corpRentalExpense, corpOtherExpenses, corpTaxableIncome, corpTax, corpNetProfit,
                personalSalaryIncome, personalRentalIncome: personalRentalBusinessIncome, personalFinancialIncome: personalTotalFinancialIncome,
                personalTotalFinancialIncome, isFinancialTaxTarget, corpRetainedEarnings, personalCapitalGains, personalNetSavings, totalNetAssetGrowth,
                personalTotalGrossIncome, monthlyGrossSalary, monthlyNationalPension, monthlyHealthInsurance, monthlyLongTermCare,
                monthlyEmploymentInsurance, monthlyNetSalary
            };
        }

        function runAllCalculations() {
            const inputs = getInputsFromState();
            const annualResult = calculateYear(inputs);
            updateSimulatorUI(annualResult);
            
            const activeTabButton = document.querySelector('.tab-button.active');
            if (!activeTabButton) return;
            const activeTab = activeTabButton.getAttribute('onclick');

            if (activeTab.includes('dashboard')) {
                updateDashboard(inputs);
            } else if (activeTab.includes('projection')) {
                runLongTermProjection(inputs);
            }
        }
        
        function getInputsFromState() {
            const inputs = {};
            inputIds.forEach(id => {
                const element = document.getElementById(id);
                const value = element ? element.value : currentScenario[id];
                if (['corpCapital', 'ceoSalary', 'taxServiceFee', 'corpOperatingFee', 'officePrice', 'rentalExpenses', 'personalInvestCapital'].includes(id)) {
                    inputs[id] = parseNumber(value);
                } else {
                    inputs[id] = parseFloat(value) || 0;
                }
            });
            
            const processedInputs = {};
            processedInputs.corpCapital = inputs.corpCapital;
            processedInputs.corpRoi = inputs.corpRoi / 100;
            processedInputs.ceoSalaryMonthly = inputs.ceoSalary;
            processedInputs.taxServiceFee = inputs.taxServiceFee;
            processedInputs.corpOperatingFee = inputs.corpOperatingFee;
            processedInputs.officePrice = inputs.officePrice;
            processedInputs.rentalYield = inputs.rentalYield / 100;
            processedInputs.rentalExpenses = inputs.rentalExpenses;
            processedInputs.personalInvestCapital = inputs.personalInvestCapital;
            processedInputs.personalDividendYield = inputs.personalDividendYield / 100;
            processedInputs.personalCapitalGainsRoi = inputs.personalCapitalGainsRoi / 100;

            return processedInputs;
        }
        
        function updateStateFromDom() {
            inputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                   currentScenario[id] = element.value;
                }
            });
        }

        function updateDomFromState() {
             inputIds.forEach(id => {
                if (currentScenario[id] !== undefined) {
                    const el = document.getElementById(id);
                    if (el) {
                       el.value = currentScenario[id];
                       if (koreanUnitTargetIds.includes(id)) {
                           document.getElementById(id + 'Korean').textContent = toKoreanWon(parseNumber(el.value));
                       }
                    }
                }
            });
        }

        function updateSimulatorUI(data) {
            Object.keys(data).forEach(key => {
                if (elements[key] && typeof data[key] !== 'boolean') {
                    elements[key].textContent = formatKRW(data[key]);
                }
            });
            if (elements.taxWarning) {
                if (data.isFinancialTaxTarget) {
                    elements.taxWarning.innerHTML = `<span class="warning">경고: 금융소득 종합과세 대상입니다.</span>`;
                    elements.taxWarning.className = 'text-center p-2 rounded-md mt-2 bg-red-100 text-red-700 font-bold';
                } else {
                    elements.taxWarning.innerHTML = `<span class="safe">안전: 금융소득 분리과세 대상입니다.</span>`;
                    elements.taxWarning.className = 'text-center p-2 rounded-md mt-2 bg-green-100 text-green-700 font-bold';
                }
            }
        }

        function updateDashboard(inputs) {
            const totalAssets = inputs.corpCapital + inputs.officePrice + inputs.personalInvestCapital;
            if (totalAssets === 0) return;
            const data = {
                labels: ['법인 운용자금', '부동산 (오피스텔)', '개인 금융투자'],
                datasets: [{ data: [inputs.corpCapital, inputs.officePrice, inputs.personalInvestCapital], backgroundColor: ['#3b82f6', '#16a34a', '#8b5cf6'], hoverOffset: 4 }]
            };
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            if (portfolioChartInstance) portfolioChartInstance.destroy();
            portfolioChartInstance = new Chart(ctx, { type: 'pie', data: data, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
            
            if (elements.portfolioSummary) {
                elements.portfolioSummary.innerHTML = `
                    <div class="p-4 bg-gray-100 rounded-lg"><h3 class="font-bold text-lg text-gray-800 mb-2">총 자산</h3><p class="text-2xl font-bold text-blue-800">${formatKRW(totalAssets)}</p></div>
                    <div class="p-4 bg-blue-50 rounded-lg"><p class="font-semibold">법인 운용자금</p><p class="text-xl font-bold text-blue-600">${formatKRW(inputs.corpCapital)} (${((inputs.corpCapital/totalAssets)*100).toFixed(1)}%)</p></div>
                    <div class="p-4 bg-green-50 rounded-lg"><p class="font-semibold">부동산 (오피스텔)</p><p class="text-xl font-bold text-green-600">${formatKRW(inputs.officePrice)} (${((inputs.officePrice/totalAssets)*100).toFixed(1)}%)</p></div>
                    <div class="p-4 bg-purple-50 rounded-lg"><p class="font-semibold">개인 금융투자</p><p class="text-xl font-bold text-purple-600">${formatKRW(inputs.personalInvestCapital)} (${((inputs.personalInvestCapital/totalAssets)*100).toFixed(1)}%)</p></div>
                `;
            }
        }

        function runLongTermProjection(initialInputs) {
            let projectionData = [];
            let currentCorpCapital = initialInputs.corpCapital;
            let currentPersonalCapital = initialInputs.personalInvestCapital;
            for (let year = 1; year <= 25; year++) {
                // 가수금 회수 로직 (4년마다)
                if (year > 1 && year % 4 === 0) {
                    const withdrawalAmount = 200000000;
                    if (currentCorpCapital >= withdrawalAmount) {
                        currentCorpCapital -= withdrawalAmount;
                        currentPersonalCapital += withdrawalAmount;
                    }
                }

                const yearInputs = { ...initialInputs, corpCapital: currentCorpCapital, personalInvestCapital: currentPersonalCapital };
                const result = calculateYear(yearInputs);
                
                // 자산 증식 로직
                currentCorpCapital += result.corpRetainedEarnings;
                currentPersonalCapital += result.personalCapitalGains + result.personalNetSavings;

                projectionData.push({
                    year: year, totalAssets: currentCorpCapital + initialInputs.officePrice + currentPersonalCapital,
                    corpAssets: currentCorpCapital, personalAssets: currentPersonalCapital, grossIncome: result.personalTotalGrossIncome
                });
            }
            updateProjectionUI(projectionData);
        }

        function updateProjectionUI(data) {
            const labels = data.map(d => `${d.year}년차`);
            const chartData = {
                labels: labels,
                datasets: [
                    { label: '총 자산', data: data.map(d => d.totalAssets), borderColor: '#059669', backgroundColor: '#059669', tension: 0.1 },
                    { label: '법인 자산', data: data.map(d => d.corpAssets), borderColor: '#3b82f6', backgroundColor: '#3b82f6', tension: 0.1 },
                    { label: '개인 금융자산', data: data.map(d => d.personalAssets), borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', tension: 0.1 }
                ]
            };
            const ctx = document.getElementById('projectionChart').getContext('2d');
            if (projectionChartInstance) projectionChartInstance.destroy();
            projectionChartInstance = new Chart(ctx, { type: 'line', data: chartData, options: { responsive: true, scales: { y: { ticks: { callback: (value) => `${Math.round(value / 100000000)}억` } } } } });
            
            if (elements.projectionTableBody) {
                elements.projectionTableBody.innerHTML = data.map(d => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="py-4 px-6 font-medium">${d.year}</td><td class="py-4 px-6 font-bold">${formatKRW(d.totalAssets)}</td>
                        <td class="py-4 px-6">${formatKRW(d.corpAssets)}</td><td class="py-4 px-6">${formatKRW(d.personalAssets)}</td>
                        <td class="py-4 px-6">${formatKRW(d.grossIncome)}</td>
                    </tr>`).join('');
            }
        }
        
        function showStatusMessage(message, isError = false) {
            if (!elements.statusMessage) return;
            elements.statusMessage.textContent = message;
            elements.statusMessage.className = `text-center text-sm h-6 mb-2 ${isError ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => { elements.statusMessage.textContent = ''; }, 3000);
        }

        if (elements.saveButton) {
            elements.saveButton.addEventListener('click', () => {
                const slot = elements.scenarioSlot.value;
                updateStateFromDom();
                localStorage.setItem(`retirementScenario_${slot}`, JSON.stringify(currentScenario));
                showStatusMessage(`시나리오 ${slot}이(가) 성공적으로 저장되었습니다.`);
            });
        }

        if (elements.loadButton) {
            elements.loadButton.addEventListener('click', () => {
                const slot = elements.scenarioSlot.value;
                const savedData = localStorage.getItem(`retirementScenario_${slot}`);
                if (savedData) {
                    currentScenario = JSON.parse(savedData);
                    updateDomFromState();
                    runAllCalculations();
                    showStatusMessage(`저장된 시나리오 ${slot}을(를) 불러왔습니다.`);
                } else {
                    showStatusMessage(`저장된 시나리오 ${slot}이(가) 없습니다.`, true);
                }
            });
        }

        function calculateCorporateTax(income) {
            if (income <= 200000000) return income * 0.09;
            if (income <= 20000000000) return 18000000 + (income - 200000000) * 0.19;
            return 18000000 + (20000000000 - 200000000) * 0.19 + (income - 20000000000) * 0.21;
        }
        function calculateSalaryDeduction(salary) {
            if (salary <= 5000000) return salary * 0.7;
            if (salary <= 15000000) return 3500000 + (salary - 5000000) * 0.4;
            if (salary <= 45000000) return 7500000 + (salary - 15000000) * 0.15;
            if (salary <= 100000000) return 12000000 + (salary - 45000000) * 0.05;
            return 14750000 + (salary - 100000000) * 0.02;
        }
        function calculateIncomeTax(income) {
            const rates = [0.06, 0.15, 0.24, 0.35, 0.38, 0.40, 0.42, 0.45];
            const brackets = [14000000, 50000000, 88000000, 150000000, 300000000, 500000000, 1000000000];
            const deductions = [0, 1260000, 5760000, 15440000, 19940000, 25940000, 35940000, 65940000];
            let bracketIndex = brackets.findIndex(b => income <= b);
            if (bracketIndex === -1) bracketIndex = 7;
            return Math.max(0, income * rates[bracketIndex] - deductions[bracketIndex]);
        }

        function changeTab(event, tabName) {
            updateStateFromDom();
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            runAllCalculations();
        }

        window.onload = () => {
            updateStateFromDom();
            updateDomFromState(); // To apply Korean units on initial load
            runAllCalculations();
        };
    </script>
</body>
</html>
